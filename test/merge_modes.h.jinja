// WARNING: This file was auto-generated by: {{ script }}
#include "evdev-scancodes.h"
#include <xkbcommon/xkbcommon.h>

#include "src/utils.h"
#include "test.h"

{%- macro key_seq(entry, type, level) -%}
        {% if entry[type].levels[level].target_group < 2 %}
        {{- entry.key.c }}, BOTH, {{ entry[type].levels[level].keysyms_c -}}
        {% else %}
        {{- entry.key.c }}, DOWN, {{ entry[type].levels[level].keysyms_c }}, NEXT,
        {{ entry.key.c }}, UP, {{
            alt_keysym(entry[type].levels[level].target_group,
                       entry[type].levels[level].target_level + level).c
        -}}
        {% endif %}
{% endmacro %}

{% macro make_test(type, tests_group) -%}
    const char keymap_{{ tests_group.name }}_{{ type }}[] =
        "xkb_keymap {\n"
        "  xkb_keycodes { include \"evdev\" };\n"
        "  xkb_types { include \"complete\" };\n"
        "  xkb_compat { include \"complete\" };\n"
        "  xkb_symbols {\n"
        // NOTE: Separate statements so that *all* the merge modes *really* work.
        //       Using + and | separators downgrades `replace key` to `override/
        //       augment key`.
        "    include \"pc\"\n"
        "    include \"{{symbols_file}}({{ tests_group.name }}_base)\"\n"
        "    {{ type }} \"{{symbols_file}}({{ tests_group.name }}_new)\"\n"
        "    include \"{{-symbols_file}}(group2):2+{{symbols_file}}(group3):3\"\n"
        "  };\n"
        "};";
    fprintf(stderr, "*** test_merge_modes: {{ tests_group.name }}, {{ type }} ***\n");
    keymap = test_compile_buffer(ctx, keymap_{{ tests_group.name }}_{{type}},
                                 ARRAY_SIZE(keymap_{{ tests_group.name }}_{{type}}));
    assert(test_key_seq(keymap,
        {%- for entry in tests_group.tests +%}
        {{ key_seq(entry, type, 0) }}, {% if entry[type].levels|length > 1 -%} NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        {{ key_seq(entry, type, 1) }}, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L,
        {%- endif %}{% if not loop.last %} NEXT,{% endif %}
        {% endfor %} FINISH
    ));
    xkb_keymap_unref(keymap);
{%- endmacro %}

static void
test_merge_modes(struct xkb_context *ctx)
{
    struct xkb_keymap *keymap;
    {% for tests_group in tests_groups %}

    /****************************************************************
     * Test group: {{ tests_group.name }}
     ****************************************************************/

    /* Mode: Augment */
    {{ make_test("augment", tests_group) }}

    /* Mode: Override */
    {{ make_test("override", tests_group) }}
    {% endfor %}
}
