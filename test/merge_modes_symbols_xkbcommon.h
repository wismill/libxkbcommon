// WARNING: This file was auto-generated by: scripts/update-symbols-tests.py
#include "evdev-scancodes.h"
#include <xkbcommon/xkbcommon.h>

#include "src/utils.h"
#include "test.h"

static void
test_symbols_merge_modes_xkbcommon(struct xkb_context *ctx,
                                   test_compile_buffer_t compile_buffer, void* private)
{
    struct xkb_keymap *keymap;

    /****************************************************************
     * Test group: keysyms-only
     ****************************************************************/

    /* Mode: Default */
    const char keymap_keysyms_only_include[] =
        "xkb_keymap {\n"
        "  xkb_keycodes { include \"evdev\" };\n"
        "  xkb_types { include \"basic+numpad+extra\" };\n"
        "  xkb_compat { include \"basic+iso9995\" };\n"
        "  xkb_symbols {\n"
        "    key <LFSH> { [Shift_L] };\n"
        "    key <RALT> { [ISO_Level3_Shift] };\n"
        "    modifier_map Shift { <LFSH> };\n"
        "    modifier_map Mod5 { <RALT> };\n"
        // NOTE: Separate statements so that *all* the merge modes *really* work.
        //       Using + and | separators downgrades `replace key` to `override/
        //       augment key`.
        "    include \"merge_modes_xkbcommon(keysyms-only_base)\"\n"
        "    include \"merge_modes_xkbcommon(keysyms-only_new)\"\n"
        "    include \"merge_modes_xkbcommon(group2):2+merge_modes_xkbcommon(group3):3\"\n"
        "  };\n"
        "};";
    fprintf(stderr, "*** test_merge_modes: keysyms-only, include ***\n");
    keymap = compile_buffer(ctx, keymap_keysyms_only_include,
                            ARRAY_SIZE(keymap_keysyms_only_include),
                            private);
    assert(keymap);
    assert_printf(test_key_seq(keymap,
        // Same key
        KEY_REDO, BOTH, XKB_KEY_a, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_REDO, BOTH, XKB_KEY_A, XKB_KEY_Y, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        // Mismatch levels count
        KEY_Q, BOTH, XKB_KEY_Greek_alpha, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_Q, BOTH, XKB_KEY_A, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_RIGHTALT, DOWN, XKB_KEY_ISO_Level3_Shift, NEXT,
        KEY_Q, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_RIGHTALT, UP, XKB_KEY_ISO_Level3_Shift, NEXT,
        KEY_W, BOTH, XKB_KEY_Greek_alpha, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_W, BOTH, XKB_KEY_A, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_RIGHTALT, DOWN, XKB_KEY_ISO_Level3_Shift, NEXT,
        KEY_W, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_RIGHTALT, UP, XKB_KEY_ISO_Level3_Shift, NEXT,
        // Single keysyms -> single keysyms
        KEY_Y, BOTH, XKB_KEY_Greek_alpha, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_Y, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_P, BOTH, XKB_KEY_Greek_alpha, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_P, BOTH, XKB_KEY_A, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        // Single keysyms -> multiple keysyms
        KEY_A, BOTH, XKB_KEY_Greek_alpha, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_A, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_S, BOTH, XKB_KEY_Greek_alpha, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_S, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_D, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_D, BOTH, XKB_KEY_Greek_ALPHA, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_F, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_F, BOTH, XKB_KEY_Greek_ALPHA, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_G, BOTH, XKB_KEY_Greek_alpha, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_G, BOTH, XKB_KEY_Greek_ALPHA, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_H, BOTH, XKB_KEY_Greek_alpha, XKB_KEY_Greek_upsilon, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_H, BOTH, XKB_KEY_Greek_ALPHA, XKB_KEY_Greek_UPSILON, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_J, BOTH, XKB_KEY_Greek_alpha, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_J, BOTH, XKB_KEY_A, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_K, BOTH, XKB_KEY_Greek_alpha, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_K, BOTH, XKB_KEY_A, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_L, BOTH, XKB_KEY_a, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_L, BOTH, XKB_KEY_Greek_ALPHA, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_SEMICOLON, BOTH, XKB_KEY_a, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_SEMICOLON, BOTH, XKB_KEY_Greek_ALPHA, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_APOSTROPHE, BOTH, XKB_KEY_Greek_alpha, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_APOSTROPHE, BOTH, XKB_KEY_Greek_ALPHA, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_BACKSLASH, BOTH, XKB_KEY_Greek_alpha, XKB_KEY_Greek_upsilon, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_BACKSLASH, BOTH, XKB_KEY_Greek_ALPHA, XKB_KEY_Greek_UPSILON, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        // Multiple keysyms -> multiple keysyms
        KEY_Z, BOTH, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_Z, BOTH, XKB_KEY_Greek_ALPHA, XKB_KEY_Greek_UPSILON, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_X, BOTH, XKB_KEY_Greek_alpha, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_X, BOTH, XKB_KEY_NoSymbol, XKB_KEY_Greek_BETA, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_C, BOTH, XKB_KEY_Greek_alpha, XKB_KEY_Greek_upsilon, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_C, BOTH, XKB_KEY_Greek_ALPHA, XKB_KEY_Greek_UPSILON, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_V, BOTH, XKB_KEY_Greek_alpha, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_V, BOTH, XKB_KEY_NoSymbol, XKB_KEY_Greek_BETA, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_B, BOTH, XKB_KEY_Greek_alpha, XKB_KEY_Greek_upsilon, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_B, BOTH, XKB_KEY_Greek_XI, XKB_KEY_Greek_BETA, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_N, BOTH, XKB_KEY_a, XKB_KEY_y, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_N, BOTH, XKB_KEY_Greek_ALPHA, XKB_KEY_Greek_UPSILON, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_M, BOTH, XKB_KEY_Greek_alpha, XKB_KEY_y, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_M, BOTH, XKB_KEY_X, XKB_KEY_Greek_BETA, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_COMMA, BOTH, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_COMMA, BOTH, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_DOT, BOTH, XKB_KEY_Greek_alpha, XKB_KEY_NoSymbol, XKB_KEY_Greek_xi, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_DOT, BOTH, XKB_KEY_Greek_XI, XKB_KEY_Greek_BETA, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_SLASH, BOTH, XKB_KEY_a, XKB_KEY_y, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_SLASH, BOTH, XKB_KEY_X, XKB_KEY_NoSymbol, XKB_KEY_A, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_RO, BOTH, XKB_KEY_Greek_alpha, XKB_KEY_NoSymbol, XKB_KEY_Greek_xi, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_RO, BOTH, XKB_KEY_Greek_XI, XKB_KEY_Greek_BETA, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        // Multiple keysyms -> single keysyms
        KEY_GRAVE, BOTH, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_GRAVE, BOTH, XKB_KEY_A, XKB_KEY_Y, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_1, BOTH, XKB_KEY_Greek_alpha, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_1, BOTH, XKB_KEY_Greek_ALPHA, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_2, BOTH, XKB_KEY_a, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_2, BOTH, XKB_KEY_NoSymbol, XKB_KEY_B, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_3, BOTH, XKB_KEY_Greek_alpha, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_3, BOTH, XKB_KEY_Greek_ALPHA, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        // Mix
        KEY_4, BOTH, XKB_KEY_Greek_alpha, XKB_KEY_Greek_upsilon, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_4, BOTH, XKB_KEY_Greek_ALPHA, XKB_KEY_Greek_UPSILON, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_5, BOTH, XKB_KEY_Greek_alpha, XKB_KEY_Greek_upsilon, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_5, BOTH, XKB_KEY_Greek_ALPHA, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_6, BOTH, XKB_KEY_Greek_alpha, XKB_KEY_Greek_upsilon, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_6, BOTH, XKB_KEY_Greek_ALPHA, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, FINISH
    ), "test_merge_modes: keysyms-only, include\n");
    xkb_keymap_unref(keymap);

    /* Mode: Augment */
    const char keymap_keysyms_only_augment[] =
        "xkb_keymap {\n"
        "  xkb_keycodes { include \"evdev\" };\n"
        "  xkb_types { include \"basic+numpad+extra\" };\n"
        "  xkb_compat { include \"basic+iso9995\" };\n"
        "  xkb_symbols {\n"
        "    key <LFSH> { [Shift_L] };\n"
        "    key <RALT> { [ISO_Level3_Shift] };\n"
        "    modifier_map Shift { <LFSH> };\n"
        "    modifier_map Mod5 { <RALT> };\n"
        // NOTE: Separate statements so that *all* the merge modes *really* work.
        //       Using + and | separators downgrades `replace key` to `override/
        //       augment key`.
        "    include \"merge_modes_xkbcommon(keysyms-only_base)\"\n"
        "    augment \"merge_modes_xkbcommon(keysyms-only_new)\"\n"
        "    include \"merge_modes_xkbcommon(group2):2+merge_modes_xkbcommon(group3):3\"\n"
        "  };\n"
        "};";
    fprintf(stderr, "*** test_merge_modes: keysyms-only, augment ***\n");
    keymap = compile_buffer(ctx, keymap_keysyms_only_augment,
                            ARRAY_SIZE(keymap_keysyms_only_augment),
                            private);
    assert(keymap);
    assert_printf(test_key_seq(keymap,
        // Same key
        KEY_REDO, BOTH, XKB_KEY_a, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_REDO, BOTH, XKB_KEY_A, XKB_KEY_Y, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        // Mismatch levels count
        KEY_Q, BOTH, XKB_KEY_Greek_alpha, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_Q, BOTH, XKB_KEY_A, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_RIGHTALT, DOWN, XKB_KEY_ISO_Level3_Shift, NEXT,
        KEY_Q, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_RIGHTALT, UP, XKB_KEY_ISO_Level3_Shift, NEXT,
        KEY_W, BOTH, XKB_KEY_Greek_alpha, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_W, BOTH, XKB_KEY_A, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_RIGHTALT, DOWN, XKB_KEY_ISO_Level3_Shift, NEXT,
        KEY_W, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_RIGHTALT, UP, XKB_KEY_ISO_Level3_Shift, NEXT,
        // Single keysyms -> single keysyms
        KEY_Y, BOTH, XKB_KEY_Greek_alpha, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_Y, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_P, BOTH, XKB_KEY_a, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_P, BOTH, XKB_KEY_A, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        // Single keysyms -> multiple keysyms
        KEY_A, BOTH, XKB_KEY_Greek_alpha, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_A, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_S, BOTH, XKB_KEY_Greek_alpha, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_S, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_D, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_D, BOTH, XKB_KEY_Greek_ALPHA, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_F, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_F, BOTH, XKB_KEY_Greek_ALPHA, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_G, BOTH, XKB_KEY_Greek_alpha, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_G, BOTH, XKB_KEY_Greek_ALPHA, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_H, BOTH, XKB_KEY_Greek_alpha, XKB_KEY_Greek_upsilon, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_H, BOTH, XKB_KEY_Greek_ALPHA, XKB_KEY_Greek_UPSILON, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_J, BOTH, XKB_KEY_a, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_J, BOTH, XKB_KEY_A, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_K, BOTH, XKB_KEY_a, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_K, BOTH, XKB_KEY_A, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_L, BOTH, XKB_KEY_a, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_L, BOTH, XKB_KEY_A, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_SEMICOLON, BOTH, XKB_KEY_a, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_SEMICOLON, BOTH, XKB_KEY_A, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_APOSTROPHE, BOTH, XKB_KEY_a, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_APOSTROPHE, BOTH, XKB_KEY_A, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_BACKSLASH, BOTH, XKB_KEY_a, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_BACKSLASH, BOTH, XKB_KEY_A, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        // Multiple keysyms -> multiple keysyms
        KEY_Z, BOTH, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_Z, BOTH, XKB_KEY_Greek_ALPHA, XKB_KEY_Greek_UPSILON, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_X, BOTH, XKB_KEY_Greek_alpha, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_X, BOTH, XKB_KEY_NoSymbol, XKB_KEY_Greek_BETA, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_C, BOTH, XKB_KEY_Greek_alpha, XKB_KEY_Greek_upsilon, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_C, BOTH, XKB_KEY_A, XKB_KEY_Y, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_V, BOTH, XKB_KEY_a, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_V, BOTH, XKB_KEY_NoSymbol, XKB_KEY_B, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_B, BOTH, XKB_KEY_a, XKB_KEY_Greek_upsilon, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_B, BOTH, XKB_KEY_Greek_XI, XKB_KEY_B, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_N, BOTH, XKB_KEY_a, XKB_KEY_y, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_N, BOTH, XKB_KEY_A, XKB_KEY_Y, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_M, BOTH, XKB_KEY_a, XKB_KEY_y, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_M, BOTH, XKB_KEY_X, XKB_KEY_B, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_COMMA, BOTH, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_COMMA, BOTH, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_DOT, BOTH, XKB_KEY_Greek_alpha, XKB_KEY_NoSymbol, XKB_KEY_Greek_xi, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_DOT, BOTH, XKB_KEY_Greek_XI, XKB_KEY_Greek_BETA, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_SLASH, BOTH, XKB_KEY_a, XKB_KEY_y, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_SLASH, BOTH, XKB_KEY_X, XKB_KEY_NoSymbol, XKB_KEY_A, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_RO, BOTH, XKB_KEY_a, XKB_KEY_y, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_RO, BOTH, XKB_KEY_X, XKB_KEY_NoSymbol, XKB_KEY_A, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        // Multiple keysyms -> single keysyms
        KEY_GRAVE, BOTH, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_GRAVE, BOTH, XKB_KEY_A, XKB_KEY_Y, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_1, BOTH, XKB_KEY_Greek_alpha, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_1, BOTH, XKB_KEY_A, XKB_KEY_Y, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_2, BOTH, XKB_KEY_a, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_2, BOTH, XKB_KEY_NoSymbol, XKB_KEY_B, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_3, BOTH, XKB_KEY_a, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_3, BOTH, XKB_KEY_NoSymbol, XKB_KEY_B, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        // Mix
        KEY_4, BOTH, XKB_KEY_a, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_4, BOTH, XKB_KEY_Greek_ALPHA, XKB_KEY_Greek_UPSILON, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_5, BOTH, XKB_KEY_a, XKB_KEY_y, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_5, BOTH, XKB_KEY_Greek_ALPHA, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_6, BOTH, XKB_KEY_a, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_6, BOTH, XKB_KEY_A, XKB_KEY_Y, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, FINISH
    ), "test_merge_modes: keysyms-only, augment\n");
    xkb_keymap_unref(keymap);

    /* Mode: Override */
    const char keymap_keysyms_only_override[] =
        "xkb_keymap {\n"
        "  xkb_keycodes { include \"evdev\" };\n"
        "  xkb_types { include \"basic+numpad+extra\" };\n"
        "  xkb_compat { include \"basic+iso9995\" };\n"
        "  xkb_symbols {\n"
        "    key <LFSH> { [Shift_L] };\n"
        "    key <RALT> { [ISO_Level3_Shift] };\n"
        "    modifier_map Shift { <LFSH> };\n"
        "    modifier_map Mod5 { <RALT> };\n"
        // NOTE: Separate statements so that *all* the merge modes *really* work.
        //       Using + and | separators downgrades `replace key` to `override/
        //       augment key`.
        "    include \"merge_modes_xkbcommon(keysyms-only_base)\"\n"
        "    override \"merge_modes_xkbcommon(keysyms-only_new)\"\n"
        "    include \"merge_modes_xkbcommon(group2):2+merge_modes_xkbcommon(group3):3\"\n"
        "  };\n"
        "};";
    fprintf(stderr, "*** test_merge_modes: keysyms-only, override ***\n");
    keymap = compile_buffer(ctx, keymap_keysyms_only_override,
                            ARRAY_SIZE(keymap_keysyms_only_override),
                            private);
    assert(keymap);
    assert_printf(test_key_seq(keymap,
        // Same key
        KEY_REDO, BOTH, XKB_KEY_a, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_REDO, BOTH, XKB_KEY_A, XKB_KEY_Y, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        // Mismatch levels count
        KEY_Q, BOTH, XKB_KEY_Greek_alpha, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_Q, BOTH, XKB_KEY_A, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_RIGHTALT, DOWN, XKB_KEY_ISO_Level3_Shift, NEXT,
        KEY_Q, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_RIGHTALT, UP, XKB_KEY_ISO_Level3_Shift, NEXT,
        KEY_W, BOTH, XKB_KEY_Greek_alpha, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_W, BOTH, XKB_KEY_A, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_RIGHTALT, DOWN, XKB_KEY_ISO_Level3_Shift, NEXT,
        KEY_W, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_RIGHTALT, UP, XKB_KEY_ISO_Level3_Shift, NEXT,
        // Single keysyms -> single keysyms
        KEY_Y, BOTH, XKB_KEY_Greek_alpha, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_Y, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_P, BOTH, XKB_KEY_Greek_alpha, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_P, BOTH, XKB_KEY_A, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        // Single keysyms -> multiple keysyms
        KEY_A, BOTH, XKB_KEY_Greek_alpha, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_A, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_S, BOTH, XKB_KEY_Greek_alpha, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_S, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_D, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_D, BOTH, XKB_KEY_Greek_ALPHA, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_F, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_F, BOTH, XKB_KEY_Greek_ALPHA, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_G, BOTH, XKB_KEY_Greek_alpha, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_G, BOTH, XKB_KEY_Greek_ALPHA, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_H, BOTH, XKB_KEY_Greek_alpha, XKB_KEY_Greek_upsilon, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_H, BOTH, XKB_KEY_Greek_ALPHA, XKB_KEY_Greek_UPSILON, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_J, BOTH, XKB_KEY_Greek_alpha, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_J, BOTH, XKB_KEY_A, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_K, BOTH, XKB_KEY_Greek_alpha, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_K, BOTH, XKB_KEY_A, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_L, BOTH, XKB_KEY_a, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_L, BOTH, XKB_KEY_Greek_ALPHA, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_SEMICOLON, BOTH, XKB_KEY_a, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_SEMICOLON, BOTH, XKB_KEY_Greek_ALPHA, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_APOSTROPHE, BOTH, XKB_KEY_Greek_alpha, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_APOSTROPHE, BOTH, XKB_KEY_Greek_ALPHA, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_BACKSLASH, BOTH, XKB_KEY_Greek_alpha, XKB_KEY_Greek_upsilon, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_BACKSLASH, BOTH, XKB_KEY_Greek_ALPHA, XKB_KEY_Greek_UPSILON, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        // Multiple keysyms -> multiple keysyms
        KEY_Z, BOTH, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_Z, BOTH, XKB_KEY_Greek_ALPHA, XKB_KEY_Greek_UPSILON, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_X, BOTH, XKB_KEY_Greek_alpha, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_X, BOTH, XKB_KEY_NoSymbol, XKB_KEY_Greek_BETA, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_C, BOTH, XKB_KEY_Greek_alpha, XKB_KEY_Greek_upsilon, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_C, BOTH, XKB_KEY_Greek_ALPHA, XKB_KEY_Greek_UPSILON, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_V, BOTH, XKB_KEY_Greek_alpha, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_V, BOTH, XKB_KEY_NoSymbol, XKB_KEY_Greek_BETA, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_B, BOTH, XKB_KEY_Greek_alpha, XKB_KEY_Greek_upsilon, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_B, BOTH, XKB_KEY_Greek_XI, XKB_KEY_Greek_BETA, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_N, BOTH, XKB_KEY_a, XKB_KEY_y, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_N, BOTH, XKB_KEY_Greek_ALPHA, XKB_KEY_Greek_UPSILON, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_M, BOTH, XKB_KEY_Greek_alpha, XKB_KEY_y, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_M, BOTH, XKB_KEY_X, XKB_KEY_Greek_BETA, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_COMMA, BOTH, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_COMMA, BOTH, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_DOT, BOTH, XKB_KEY_Greek_alpha, XKB_KEY_NoSymbol, XKB_KEY_Greek_xi, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_DOT, BOTH, XKB_KEY_Greek_XI, XKB_KEY_Greek_BETA, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_SLASH, BOTH, XKB_KEY_a, XKB_KEY_y, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_SLASH, BOTH, XKB_KEY_X, XKB_KEY_NoSymbol, XKB_KEY_A, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_RO, BOTH, XKB_KEY_Greek_alpha, XKB_KEY_NoSymbol, XKB_KEY_Greek_xi, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_RO, BOTH, XKB_KEY_Greek_XI, XKB_KEY_Greek_BETA, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        // Multiple keysyms -> single keysyms
        KEY_GRAVE, BOTH, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_GRAVE, BOTH, XKB_KEY_A, XKB_KEY_Y, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_1, BOTH, XKB_KEY_Greek_alpha, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_1, BOTH, XKB_KEY_Greek_ALPHA, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_2, BOTH, XKB_KEY_a, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_2, BOTH, XKB_KEY_NoSymbol, XKB_KEY_B, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_3, BOTH, XKB_KEY_Greek_alpha, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_3, BOTH, XKB_KEY_Greek_ALPHA, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        // Mix
        KEY_4, BOTH, XKB_KEY_Greek_alpha, XKB_KEY_Greek_upsilon, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_4, BOTH, XKB_KEY_Greek_ALPHA, XKB_KEY_Greek_UPSILON, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_5, BOTH, XKB_KEY_Greek_alpha, XKB_KEY_Greek_upsilon, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_5, BOTH, XKB_KEY_Greek_ALPHA, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_6, BOTH, XKB_KEY_Greek_alpha, XKB_KEY_Greek_upsilon, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_6, BOTH, XKB_KEY_Greek_ALPHA, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, FINISH
    ), "test_merge_modes: keysyms-only, override\n");
    xkb_keymap_unref(keymap);

    /* Mode: Replace */
    const char keymap_keysyms_only_replace[] =
        "xkb_keymap {\n"
        "  xkb_keycodes { include \"evdev\" };\n"
        "  xkb_types { include \"basic+numpad+extra\" };\n"
        "  xkb_compat { include \"basic+iso9995\" };\n"
        "  xkb_symbols {\n"
        "    key <LFSH> { [Shift_L] };\n"
        "    key <RALT> { [ISO_Level3_Shift] };\n"
        "    modifier_map Shift { <LFSH> };\n"
        "    modifier_map Mod5 { <RALT> };\n"
        // NOTE: Separate statements so that *all* the merge modes *really* work.
        //       Using + and | separators downgrades `replace key` to `override/
        //       augment key`.
        "    include \"merge_modes_xkbcommon(keysyms-only_base)\"\n"
        "    replace \"merge_modes_xkbcommon(keysyms-only_new)\"\n"
        "    include \"merge_modes_xkbcommon(group2):2+merge_modes_xkbcommon(group3):3\"\n"
        "  };\n"
        "};";
    fprintf(stderr, "*** test_merge_modes: keysyms-only, replace ***\n");
    keymap = compile_buffer(ctx, keymap_keysyms_only_replace,
                            ARRAY_SIZE(keymap_keysyms_only_replace),
                            private);
    assert(keymap);
    assert_printf(test_key_seq(keymap,
        // Same key
        KEY_REDO, BOTH, XKB_KEY_a, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_REDO, BOTH, XKB_KEY_A, XKB_KEY_Y, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        // Mismatch levels count
        KEY_Q, BOTH, XKB_KEY_Greek_alpha, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_Q, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_RIGHTALT, DOWN, XKB_KEY_ISO_Level3_Shift, NEXT,
        KEY_Q, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_RIGHTALT, UP, XKB_KEY_ISO_Level3_Shift, NEXT,
        KEY_W, BOTH, XKB_KEY_Greek_alpha, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_W, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        // Single keysyms -> single keysyms
        KEY_Y, BOTH, XKB_KEY_Greek_alpha, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_Y, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_P, BOTH, XKB_KEY_Greek_alpha, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_P, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        // Single keysyms -> multiple keysyms
        KEY_A, BOTH, XKB_KEY_Greek_alpha, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_A, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_S, BOTH, XKB_KEY_Greek_alpha, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_S, BOTH, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_D, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_D, BOTH, XKB_KEY_Greek_ALPHA, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_F, BOTH, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_F, BOTH, XKB_KEY_Greek_ALPHA, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_G, BOTH, XKB_KEY_Greek_alpha, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_G, BOTH, XKB_KEY_Greek_ALPHA, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_H, BOTH, XKB_KEY_Greek_alpha, XKB_KEY_Greek_upsilon, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_H, BOTH, XKB_KEY_Greek_ALPHA, XKB_KEY_Greek_UPSILON, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_J, BOTH, XKB_KEY_Greek_alpha, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_J, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_K, BOTH, XKB_KEY_Greek_alpha, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_K, BOTH, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_L, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_L, BOTH, XKB_KEY_Greek_ALPHA, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_SEMICOLON, BOTH, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_SEMICOLON, BOTH, XKB_KEY_Greek_ALPHA, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_APOSTROPHE, BOTH, XKB_KEY_Greek_alpha, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_APOSTROPHE, BOTH, XKB_KEY_Greek_ALPHA, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_BACKSLASH, BOTH, XKB_KEY_Greek_alpha, XKB_KEY_Greek_upsilon, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_BACKSLASH, BOTH, XKB_KEY_Greek_ALPHA, XKB_KEY_Greek_UPSILON, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        // Multiple keysyms -> multiple keysyms
        KEY_Z, BOTH, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_Z, BOTH, XKB_KEY_Greek_ALPHA, XKB_KEY_Greek_UPSILON, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_X, BOTH, XKB_KEY_Greek_alpha, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_X, BOTH, XKB_KEY_NoSymbol, XKB_KEY_Greek_BETA, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_C, BOTH, XKB_KEY_Greek_alpha, XKB_KEY_Greek_upsilon, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_C, BOTH, XKB_KEY_Greek_ALPHA, XKB_KEY_Greek_UPSILON, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_V, BOTH, XKB_KEY_Greek_alpha, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_V, BOTH, XKB_KEY_NoSymbol, XKB_KEY_Greek_BETA, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_B, BOTH, XKB_KEY_Greek_alpha, XKB_KEY_Greek_upsilon, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_B, BOTH, XKB_KEY_Greek_XI, XKB_KEY_Greek_BETA, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_N, BOTH, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_N, BOTH, XKB_KEY_Greek_ALPHA, XKB_KEY_Greek_UPSILON, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_M, BOTH, XKB_KEY_Greek_alpha, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_M, BOTH, XKB_KEY_NoSymbol, XKB_KEY_Greek_BETA, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_COMMA, BOTH, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_COMMA, BOTH, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_DOT, BOTH, XKB_KEY_Greek_alpha, XKB_KEY_NoSymbol, XKB_KEY_Greek_xi, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_DOT, BOTH, XKB_KEY_Greek_XI, XKB_KEY_Greek_BETA, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_SLASH, BOTH, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_SLASH, BOTH, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_RO, BOTH, XKB_KEY_Greek_alpha, XKB_KEY_NoSymbol, XKB_KEY_Greek_xi, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_RO, BOTH, XKB_KEY_Greek_XI, XKB_KEY_Greek_BETA, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        // Multiple keysyms -> single keysyms
        KEY_GRAVE, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_GRAVE, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_1, BOTH, XKB_KEY_Greek_alpha, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_1, BOTH, XKB_KEY_Greek_ALPHA, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_2, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_2, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_3, BOTH, XKB_KEY_Greek_alpha, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_3, BOTH, XKB_KEY_Greek_ALPHA, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        // Mix
        KEY_4, BOTH, XKB_KEY_Greek_alpha, XKB_KEY_Greek_upsilon, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_4, BOTH, XKB_KEY_Greek_ALPHA, XKB_KEY_Greek_UPSILON, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_5, BOTH, XKB_KEY_Greek_alpha, XKB_KEY_Greek_upsilon, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_5, BOTH, XKB_KEY_Greek_ALPHA, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_6, BOTH, XKB_KEY_Greek_alpha, XKB_KEY_Greek_upsilon, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_6, BOTH, XKB_KEY_Greek_ALPHA, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, FINISH
    ), "test_merge_modes: keysyms-only, replace\n");
    xkb_keymap_unref(keymap);

    /****************************************************************
     * Test group: actions-only
     ****************************************************************/

    /* Mode: Default */
    const char keymap_actions_only_include[] =
        "xkb_keymap {\n"
        "  xkb_keycodes { include \"evdev\" };\n"
        "  xkb_types { include \"basic+numpad+extra\" };\n"
        "  xkb_compat { include \"basic+iso9995\" };\n"
        "  xkb_symbols {\n"
        "    key <LFSH> { [Shift_L] };\n"
        "    key <RALT> { [ISO_Level3_Shift] };\n"
        "    modifier_map Shift { <LFSH> };\n"
        "    modifier_map Mod5 { <RALT> };\n"
        // NOTE: Separate statements so that *all* the merge modes *really* work.
        //       Using + and | separators downgrades `replace key` to `override/
        //       augment key`.
        "    include \"merge_modes_xkbcommon(actions-only_base)\"\n"
        "    include \"merge_modes_xkbcommon(actions-only_new)\"\n"
        "    include \"merge_modes_xkbcommon(group2):2+merge_modes_xkbcommon(group3):3\"\n"
        "  };\n"
        "};";
    fprintf(stderr, "*** test_merge_modes: actions-only, include ***\n");
    keymap = compile_buffer(ctx, keymap_actions_only_include,
                            ARRAY_SIZE(keymap_actions_only_include),
                            private);
    assert(keymap);
    assert_printf(test_key_seq(keymap,
        // Same key
        KEY_REDO, DOWN, XKB_KEY_NoSymbol, NEXT,
        KEY_REDO, UP, XKB_KEY_Ukrainian_i, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_REDO, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_REDO, UP, XKB_KEY_Ukrainian_I, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        // Mismatch levels count
        KEY_Q, DOWN, XKB_KEY_NoSymbol, NEXT,
        KEY_Q, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_Q, DOWN, XKB_KEY_NoSymbol, NEXT,
        KEY_Q, UP, XKB_KEY_Ukrainian_I, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_RIGHTALT, DOWN, XKB_KEY_ISO_Level3_Shift, NEXT,
        KEY_Q, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_RIGHTALT, UP, XKB_KEY_ISO_Level3_Shift, NEXT,
        KEY_W, DOWN, XKB_KEY_NoSymbol, NEXT,
        KEY_W, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_W, DOWN, XKB_KEY_NoSymbol, NEXT,
        KEY_W, UP, XKB_KEY_Ukrainian_I, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_RIGHTALT, DOWN, XKB_KEY_ISO_Level3_Shift, NEXT,
        KEY_W, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_RIGHTALT, UP, XKB_KEY_ISO_Level3_Shift, NEXT,
        // Single keysyms -> single keysyms
        KEY_Y, DOWN, XKB_KEY_NoSymbol, NEXT,
        KEY_Y, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_Y, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_P, DOWN, XKB_KEY_NoSymbol, NEXT,
        KEY_P, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_P, DOWN, XKB_KEY_NoSymbol, NEXT,
        KEY_P, UP, XKB_KEY_Ukrainian_I, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        // Single keysyms -> multiple keysyms
        KEY_A, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_A, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_A, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_S, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_S, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_S, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_D, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_D, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_D, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_F, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_F, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_F, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_G, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_G, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_G, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_G, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_H, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_H, UP, XKB_KEY_c_h, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_H, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_H, UP, XKB_KEY_C_h, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_J, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_J, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_J, DOWN, XKB_KEY_NoSymbol, NEXT,
        KEY_J, UP, XKB_KEY_Ukrainian_I, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_K, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_K, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_K, DOWN, XKB_KEY_NoSymbol, NEXT,
        KEY_K, UP, XKB_KEY_Ukrainian_I, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_L, DOWN, XKB_KEY_NoSymbol, NEXT,
        KEY_L, UP, XKB_KEY_Ukrainian_i, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_L, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_L, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_SEMICOLON, DOWN, XKB_KEY_NoSymbol, NEXT,
        KEY_SEMICOLON, UP, XKB_KEY_Ukrainian_i, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_SEMICOLON, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_SEMICOLON, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_APOSTROPHE, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_APOSTROPHE, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_APOSTROPHE, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_APOSTROPHE, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_BACKSLASH, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_BACKSLASH, UP, XKB_KEY_c_h, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_BACKSLASH, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_BACKSLASH, UP, XKB_KEY_C_h, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        // Multiple keysyms -> multiple keysyms
        KEY_Z, BOTH, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_Z, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_Z, UP, XKB_KEY_C_h, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_X, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_X, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_X, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_X, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_C, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_C, UP, XKB_KEY_c_h, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_C, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_C, UP, XKB_KEY_C_h, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_V, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_V, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_V, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_V, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_B, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_B, UP, XKB_KEY_c_h, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_B, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_B, UP, XKB_KEY_C_h, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_N, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_N, UP, XKB_KEY_Ukrainian_i, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_N, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_N, UP, XKB_KEY_C_h, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_M, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_M, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_M, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_M, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_COMMA, BOTH, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_COMMA, BOTH, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_DOT, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_DOT, UP, XKB_KEY_c_h, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_DOT, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_DOT, UP, XKB_KEY_C_h, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_SLASH, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_SLASH, UP, XKB_KEY_Ukrainian_i, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_SLASH, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_SLASH, UP, XKB_KEY_Ukrainian_I, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_RO, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_RO, UP, XKB_KEY_c_h, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_RO, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_RO, UP, XKB_KEY_C_h, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        // Multiple keysyms -> single keysyms
        KEY_GRAVE, BOTH, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_GRAVE, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_GRAVE, UP, XKB_KEY_Ukrainian_I, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_1, DOWN, XKB_KEY_NoSymbol, NEXT,
        KEY_1, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_1, DOWN, XKB_KEY_NoSymbol, NEXT,
        KEY_1, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_2, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_2, UP, XKB_KEY_Ukrainian_i, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_2, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_2, UP, XKB_KEY_Ukrainian_I, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_3, DOWN, XKB_KEY_NoSymbol, NEXT,
        KEY_3, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_3, DOWN, XKB_KEY_NoSymbol, NEXT,
        KEY_3, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        // Mix
        KEY_4, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_4, UP, XKB_KEY_c_h, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_4, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_4, UP, XKB_KEY_C_h, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_5, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_5, UP, XKB_KEY_c_h, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_5, DOWN, XKB_KEY_NoSymbol, NEXT,
        KEY_5, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_6, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_6, UP, XKB_KEY_c_h, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_6, DOWN, XKB_KEY_NoSymbol, NEXT,
        KEY_6, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, FINISH
    ), "test_merge_modes: actions-only, include\n");
    xkb_keymap_unref(keymap);

    /* Mode: Augment */
    const char keymap_actions_only_augment[] =
        "xkb_keymap {\n"
        "  xkb_keycodes { include \"evdev\" };\n"
        "  xkb_types { include \"basic+numpad+extra\" };\n"
        "  xkb_compat { include \"basic+iso9995\" };\n"
        "  xkb_symbols {\n"
        "    key <LFSH> { [Shift_L] };\n"
        "    key <RALT> { [ISO_Level3_Shift] };\n"
        "    modifier_map Shift { <LFSH> };\n"
        "    modifier_map Mod5 { <RALT> };\n"
        // NOTE: Separate statements so that *all* the merge modes *really* work.
        //       Using + and | separators downgrades `replace key` to `override/
        //       augment key`.
        "    include \"merge_modes_xkbcommon(actions-only_base)\"\n"
        "    augment \"merge_modes_xkbcommon(actions-only_new)\"\n"
        "    include \"merge_modes_xkbcommon(group2):2+merge_modes_xkbcommon(group3):3\"\n"
        "  };\n"
        "};";
    fprintf(stderr, "*** test_merge_modes: actions-only, augment ***\n");
    keymap = compile_buffer(ctx, keymap_actions_only_augment,
                            ARRAY_SIZE(keymap_actions_only_augment),
                            private);
    assert(keymap);
    assert_printf(test_key_seq(keymap,
        // Same key
        KEY_REDO, DOWN, XKB_KEY_NoSymbol, NEXT,
        KEY_REDO, UP, XKB_KEY_Ukrainian_i, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_REDO, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_REDO, UP, XKB_KEY_Ukrainian_I, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        // Mismatch levels count
        KEY_Q, DOWN, XKB_KEY_NoSymbol, NEXT,
        KEY_Q, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_Q, DOWN, XKB_KEY_NoSymbol, NEXT,
        KEY_Q, UP, XKB_KEY_Ukrainian_I, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_RIGHTALT, DOWN, XKB_KEY_ISO_Level3_Shift, NEXT,
        KEY_Q, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_RIGHTALT, UP, XKB_KEY_ISO_Level3_Shift, NEXT,
        KEY_W, DOWN, XKB_KEY_NoSymbol, NEXT,
        KEY_W, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_W, DOWN, XKB_KEY_NoSymbol, NEXT,
        KEY_W, UP, XKB_KEY_Ukrainian_I, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_RIGHTALT, DOWN, XKB_KEY_ISO_Level3_Shift, NEXT,
        KEY_W, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_RIGHTALT, UP, XKB_KEY_ISO_Level3_Shift, NEXT,
        // Single keysyms -> single keysyms
        KEY_Y, DOWN, XKB_KEY_NoSymbol, NEXT,
        KEY_Y, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_Y, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_P, DOWN, XKB_KEY_NoSymbol, NEXT,
        KEY_P, UP, XKB_KEY_Ukrainian_i, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_P, DOWN, XKB_KEY_NoSymbol, NEXT,
        KEY_P, UP, XKB_KEY_Ukrainian_I, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        // Single keysyms -> multiple keysyms
        KEY_A, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_A, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_A, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_S, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_S, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_S, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_D, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_D, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_D, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_F, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_F, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_F, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_G, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_G, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_G, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_G, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_H, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_H, UP, XKB_KEY_c_h, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_H, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_H, UP, XKB_KEY_C_h, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_J, DOWN, XKB_KEY_NoSymbol, NEXT,
        KEY_J, UP, XKB_KEY_Ukrainian_i, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_J, DOWN, XKB_KEY_NoSymbol, NEXT,
        KEY_J, UP, XKB_KEY_Ukrainian_I, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_K, DOWN, XKB_KEY_NoSymbol, NEXT,
        KEY_K, UP, XKB_KEY_Ukrainian_i, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_K, DOWN, XKB_KEY_NoSymbol, NEXT,
        KEY_K, UP, XKB_KEY_Ukrainian_I, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_L, DOWN, XKB_KEY_NoSymbol, NEXT,
        KEY_L, UP, XKB_KEY_Ukrainian_i, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_L, DOWN, XKB_KEY_NoSymbol, NEXT,
        KEY_L, UP, XKB_KEY_Ukrainian_I, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_SEMICOLON, DOWN, XKB_KEY_NoSymbol, NEXT,
        KEY_SEMICOLON, UP, XKB_KEY_Ukrainian_i, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_SEMICOLON, DOWN, XKB_KEY_NoSymbol, NEXT,
        KEY_SEMICOLON, UP, XKB_KEY_Ukrainian_I, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_APOSTROPHE, DOWN, XKB_KEY_NoSymbol, NEXT,
        KEY_APOSTROPHE, UP, XKB_KEY_Ukrainian_i, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_APOSTROPHE, DOWN, XKB_KEY_NoSymbol, NEXT,
        KEY_APOSTROPHE, UP, XKB_KEY_Ukrainian_I, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_BACKSLASH, DOWN, XKB_KEY_NoSymbol, NEXT,
        KEY_BACKSLASH, UP, XKB_KEY_Ukrainian_i, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_BACKSLASH, DOWN, XKB_KEY_NoSymbol, NEXT,
        KEY_BACKSLASH, UP, XKB_KEY_Ukrainian_I, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        // Multiple keysyms -> multiple keysyms
        KEY_Z, BOTH, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_Z, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_Z, UP, XKB_KEY_C_h, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_X, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_X, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_X, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_X, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_C, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_C, UP, XKB_KEY_c_h, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_C, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_C, UP, XKB_KEY_Ukrainian_I, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_V, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_V, UP, XKB_KEY_Ukrainian_i, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_V, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_V, UP, XKB_KEY_Ukrainian_I, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_B, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_B, UP, XKB_KEY_Ukrainian_yi, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_B, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_B, UP, XKB_KEY_Ukrainian_YI, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_N, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_N, UP, XKB_KEY_Ukrainian_i, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_N, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_N, UP, XKB_KEY_Ukrainian_I, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_M, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_M, UP, XKB_KEY_Ukrainian_i, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_M, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_M, UP, XKB_KEY_Ukrainian_I, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_COMMA, BOTH, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_COMMA, BOTH, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_DOT, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_DOT, UP, XKB_KEY_c_h, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_DOT, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_DOT, UP, XKB_KEY_C_h, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_SLASH, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_SLASH, UP, XKB_KEY_Ukrainian_i, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_SLASH, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_SLASH, UP, XKB_KEY_Ukrainian_I, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_RO, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_RO, UP, XKB_KEY_Ukrainian_i, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_RO, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_RO, UP, XKB_KEY_Ukrainian_I, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        // Multiple keysyms -> single keysyms
        KEY_GRAVE, BOTH, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_GRAVE, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_GRAVE, UP, XKB_KEY_Ukrainian_I, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_1, DOWN, XKB_KEY_NoSymbol, NEXT,
        KEY_1, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_1, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_1, UP, XKB_KEY_Ukrainian_I, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_2, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_2, UP, XKB_KEY_Ukrainian_i, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_2, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_2, UP, XKB_KEY_Ukrainian_I, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_3, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_3, UP, XKB_KEY_Ukrainian_i, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_3, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_3, UP, XKB_KEY_Ukrainian_I, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        // Mix
        KEY_4, DOWN, XKB_KEY_NoSymbol, NEXT,
        KEY_4, UP, XKB_KEY_Ukrainian_i, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_4, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_4, UP, XKB_KEY_C_h, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_5, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_5, UP, XKB_KEY_Ukrainian_i, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_5, DOWN, XKB_KEY_NoSymbol, NEXT,
        KEY_5, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_6, DOWN, XKB_KEY_NoSymbol, NEXT,
        KEY_6, UP, XKB_KEY_Ukrainian_i, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_6, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_6, UP, XKB_KEY_Ukrainian_I, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, FINISH
    ), "test_merge_modes: actions-only, augment\n");
    xkb_keymap_unref(keymap);

    /* Mode: Override */
    const char keymap_actions_only_override[] =
        "xkb_keymap {\n"
        "  xkb_keycodes { include \"evdev\" };\n"
        "  xkb_types { include \"basic+numpad+extra\" };\n"
        "  xkb_compat { include \"basic+iso9995\" };\n"
        "  xkb_symbols {\n"
        "    key <LFSH> { [Shift_L] };\n"
        "    key <RALT> { [ISO_Level3_Shift] };\n"
        "    modifier_map Shift { <LFSH> };\n"
        "    modifier_map Mod5 { <RALT> };\n"
        // NOTE: Separate statements so that *all* the merge modes *really* work.
        //       Using + and | separators downgrades `replace key` to `override/
        //       augment key`.
        "    include \"merge_modes_xkbcommon(actions-only_base)\"\n"
        "    override \"merge_modes_xkbcommon(actions-only_new)\"\n"
        "    include \"merge_modes_xkbcommon(group2):2+merge_modes_xkbcommon(group3):3\"\n"
        "  };\n"
        "};";
    fprintf(stderr, "*** test_merge_modes: actions-only, override ***\n");
    keymap = compile_buffer(ctx, keymap_actions_only_override,
                            ARRAY_SIZE(keymap_actions_only_override),
                            private);
    assert(keymap);
    assert_printf(test_key_seq(keymap,
        // Same key
        KEY_REDO, DOWN, XKB_KEY_NoSymbol, NEXT,
        KEY_REDO, UP, XKB_KEY_Ukrainian_i, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_REDO, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_REDO, UP, XKB_KEY_Ukrainian_I, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        // Mismatch levels count
        KEY_Q, DOWN, XKB_KEY_NoSymbol, NEXT,
        KEY_Q, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_Q, DOWN, XKB_KEY_NoSymbol, NEXT,
        KEY_Q, UP, XKB_KEY_Ukrainian_I, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_RIGHTALT, DOWN, XKB_KEY_ISO_Level3_Shift, NEXT,
        KEY_Q, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_RIGHTALT, UP, XKB_KEY_ISO_Level3_Shift, NEXT,
        KEY_W, DOWN, XKB_KEY_NoSymbol, NEXT,
        KEY_W, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_W, DOWN, XKB_KEY_NoSymbol, NEXT,
        KEY_W, UP, XKB_KEY_Ukrainian_I, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_RIGHTALT, DOWN, XKB_KEY_ISO_Level3_Shift, NEXT,
        KEY_W, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_RIGHTALT, UP, XKB_KEY_ISO_Level3_Shift, NEXT,
        // Single keysyms -> single keysyms
        KEY_Y, DOWN, XKB_KEY_NoSymbol, NEXT,
        KEY_Y, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_Y, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_P, DOWN, XKB_KEY_NoSymbol, NEXT,
        KEY_P, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_P, DOWN, XKB_KEY_NoSymbol, NEXT,
        KEY_P, UP, XKB_KEY_Ukrainian_I, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        // Single keysyms -> multiple keysyms
        KEY_A, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_A, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_A, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_S, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_S, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_S, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_D, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_D, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_D, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_F, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_F, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_F, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_G, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_G, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_G, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_G, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_H, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_H, UP, XKB_KEY_c_h, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_H, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_H, UP, XKB_KEY_C_h, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_J, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_J, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_J, DOWN, XKB_KEY_NoSymbol, NEXT,
        KEY_J, UP, XKB_KEY_Ukrainian_I, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_K, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_K, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_K, DOWN, XKB_KEY_NoSymbol, NEXT,
        KEY_K, UP, XKB_KEY_Ukrainian_I, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_L, DOWN, XKB_KEY_NoSymbol, NEXT,
        KEY_L, UP, XKB_KEY_Ukrainian_i, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_L, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_L, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_SEMICOLON, DOWN, XKB_KEY_NoSymbol, NEXT,
        KEY_SEMICOLON, UP, XKB_KEY_Ukrainian_i, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_SEMICOLON, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_SEMICOLON, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_APOSTROPHE, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_APOSTROPHE, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_APOSTROPHE, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_APOSTROPHE, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_BACKSLASH, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_BACKSLASH, UP, XKB_KEY_c_h, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_BACKSLASH, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_BACKSLASH, UP, XKB_KEY_C_h, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        // Multiple keysyms -> multiple keysyms
        KEY_Z, BOTH, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_Z, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_Z, UP, XKB_KEY_C_h, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_X, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_X, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_X, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_X, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_C, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_C, UP, XKB_KEY_c_h, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_C, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_C, UP, XKB_KEY_C_h, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_V, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_V, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_V, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_V, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_B, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_B, UP, XKB_KEY_c_h, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_B, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_B, UP, XKB_KEY_C_h, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_N, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_N, UP, XKB_KEY_Ukrainian_i, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_N, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_N, UP, XKB_KEY_C_h, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_M, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_M, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_M, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_M, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_COMMA, BOTH, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_COMMA, BOTH, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_DOT, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_DOT, UP, XKB_KEY_c_h, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_DOT, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_DOT, UP, XKB_KEY_C_h, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_SLASH, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_SLASH, UP, XKB_KEY_Ukrainian_i, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_SLASH, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_SLASH, UP, XKB_KEY_Ukrainian_I, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_RO, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_RO, UP, XKB_KEY_c_h, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_RO, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_RO, UP, XKB_KEY_C_h, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        // Multiple keysyms -> single keysyms
        KEY_GRAVE, BOTH, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_GRAVE, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_GRAVE, UP, XKB_KEY_Ukrainian_I, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_1, DOWN, XKB_KEY_NoSymbol, NEXT,
        KEY_1, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_1, DOWN, XKB_KEY_NoSymbol, NEXT,
        KEY_1, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_2, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_2, UP, XKB_KEY_Ukrainian_i, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_2, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_2, UP, XKB_KEY_Ukrainian_I, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_3, DOWN, XKB_KEY_NoSymbol, NEXT,
        KEY_3, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_3, DOWN, XKB_KEY_NoSymbol, NEXT,
        KEY_3, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        // Mix
        KEY_4, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_4, UP, XKB_KEY_c_h, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_4, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_4, UP, XKB_KEY_C_h, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_5, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_5, UP, XKB_KEY_c_h, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_5, DOWN, XKB_KEY_NoSymbol, NEXT,
        KEY_5, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_6, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_6, UP, XKB_KEY_c_h, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_6, DOWN, XKB_KEY_NoSymbol, NEXT,
        KEY_6, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, FINISH
    ), "test_merge_modes: actions-only, override\n");
    xkb_keymap_unref(keymap);

    /* Mode: Replace */
    const char keymap_actions_only_replace[] =
        "xkb_keymap {\n"
        "  xkb_keycodes { include \"evdev\" };\n"
        "  xkb_types { include \"basic+numpad+extra\" };\n"
        "  xkb_compat { include \"basic+iso9995\" };\n"
        "  xkb_symbols {\n"
        "    key <LFSH> { [Shift_L] };\n"
        "    key <RALT> { [ISO_Level3_Shift] };\n"
        "    modifier_map Shift { <LFSH> };\n"
        "    modifier_map Mod5 { <RALT> };\n"
        // NOTE: Separate statements so that *all* the merge modes *really* work.
        //       Using + and | separators downgrades `replace key` to `override/
        //       augment key`.
        "    include \"merge_modes_xkbcommon(actions-only_base)\"\n"
        "    replace \"merge_modes_xkbcommon(actions-only_new)\"\n"
        "    include \"merge_modes_xkbcommon(group2):2+merge_modes_xkbcommon(group3):3\"\n"
        "  };\n"
        "};";
    fprintf(stderr, "*** test_merge_modes: actions-only, replace ***\n");
    keymap = compile_buffer(ctx, keymap_actions_only_replace,
                            ARRAY_SIZE(keymap_actions_only_replace),
                            private);
    assert(keymap);
    assert_printf(test_key_seq(keymap,
        // Same key
        KEY_REDO, DOWN, XKB_KEY_NoSymbol, NEXT,
        KEY_REDO, UP, XKB_KEY_Ukrainian_i, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_REDO, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_REDO, UP, XKB_KEY_Ukrainian_I, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        // Mismatch levels count
        KEY_Q, DOWN, XKB_KEY_NoSymbol, NEXT,
        KEY_Q, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_Q, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_RIGHTALT, DOWN, XKB_KEY_ISO_Level3_Shift, NEXT,
        KEY_Q, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_RIGHTALT, UP, XKB_KEY_ISO_Level3_Shift, NEXT,
        KEY_W, DOWN, XKB_KEY_NoSymbol, NEXT,
        KEY_W, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_W, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        // Single keysyms -> single keysyms
        KEY_Y, DOWN, XKB_KEY_NoSymbol, NEXT,
        KEY_Y, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_Y, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_P, DOWN, XKB_KEY_NoSymbol, NEXT,
        KEY_P, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_P, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        // Single keysyms -> multiple keysyms
        KEY_A, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_A, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_A, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_S, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_S, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_S, BOTH, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_D, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_D, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_D, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_F, BOTH, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_F, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_F, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_G, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_G, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_G, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_G, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_H, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_H, UP, XKB_KEY_c_h, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_H, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_H, UP, XKB_KEY_C_h, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_J, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_J, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_J, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_K, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_K, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_K, BOTH, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_L, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_L, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_L, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_SEMICOLON, BOTH, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_SEMICOLON, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_SEMICOLON, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_APOSTROPHE, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_APOSTROPHE, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_APOSTROPHE, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_APOSTROPHE, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_BACKSLASH, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_BACKSLASH, UP, XKB_KEY_c_h, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_BACKSLASH, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_BACKSLASH, UP, XKB_KEY_C_h, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        // Multiple keysyms -> multiple keysyms
        KEY_Z, BOTH, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_Z, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_Z, UP, XKB_KEY_C_h, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_X, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_X, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_X, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_X, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_C, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_C, UP, XKB_KEY_c_h, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_C, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_C, UP, XKB_KEY_C_h, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_V, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_V, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_V, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_V, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_B, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_B, UP, XKB_KEY_c_h, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_B, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_B, UP, XKB_KEY_C_h, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_N, BOTH, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_N, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_N, UP, XKB_KEY_C_h, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_M, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_M, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_M, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_M, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_COMMA, BOTH, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_COMMA, BOTH, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_DOT, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_DOT, UP, XKB_KEY_c_h, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_DOT, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_DOT, UP, XKB_KEY_C_h, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_SLASH, BOTH, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_SLASH, BOTH, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_RO, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_RO, UP, XKB_KEY_c_h, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_RO, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_RO, UP, XKB_KEY_C_h, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        // Multiple keysyms -> single keysyms
        KEY_GRAVE, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_GRAVE, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_1, DOWN, XKB_KEY_NoSymbol, NEXT,
        KEY_1, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_1, DOWN, XKB_KEY_NoSymbol, NEXT,
        KEY_1, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_2, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_2, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_3, DOWN, XKB_KEY_NoSymbol, NEXT,
        KEY_3, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_3, DOWN, XKB_KEY_NoSymbol, NEXT,
        KEY_3, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        // Mix
        KEY_4, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_4, UP, XKB_KEY_c_h, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_4, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_4, UP, XKB_KEY_C_h, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_5, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_5, UP, XKB_KEY_c_h, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_5, DOWN, XKB_KEY_NoSymbol, NEXT,
        KEY_5, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_6, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_6, UP, XKB_KEY_c_h, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_6, DOWN, XKB_KEY_NoSymbol, NEXT,
        KEY_6, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, FINISH
    ), "test_merge_modes: actions-only, replace\n");
    xkb_keymap_unref(keymap);

    /****************************************************************
     * Test group: keysyms-and-actions
     ****************************************************************/

    /* Mode: Default */
    const char keymap_keysyms_and_actions_include[] =
        "xkb_keymap {\n"
        "  xkb_keycodes { include \"evdev\" };\n"
        "  xkb_types { include \"basic+numpad+extra\" };\n"
        "  xkb_compat { include \"basic+iso9995\" };\n"
        "  xkb_symbols {\n"
        "    key <LFSH> { [Shift_L] };\n"
        "    key <RALT> { [ISO_Level3_Shift] };\n"
        "    modifier_map Shift { <LFSH> };\n"
        "    modifier_map Mod5 { <RALT> };\n"
        // NOTE: Separate statements so that *all* the merge modes *really* work.
        //       Using + and | separators downgrades `replace key` to `override/
        //       augment key`.
        "    include \"merge_modes_xkbcommon(keysyms-and-actions_base)\"\n"
        "    include \"merge_modes_xkbcommon(keysyms-and-actions_new)\"\n"
        "    include \"merge_modes_xkbcommon(group2):2+merge_modes_xkbcommon(group3):3\"\n"
        "  };\n"
        "};";
    fprintf(stderr, "*** test_merge_modes: keysyms-and-actions, include ***\n");
    keymap = compile_buffer(ctx, keymap_keysyms_and_actions_include,
                            ARRAY_SIZE(keymap_keysyms_and_actions_include),
                            private);
    assert(keymap);
    assert_printf(test_key_seq(keymap,
        // Same key
        KEY_REDO, DOWN, XKB_KEY_a, NEXT,
        KEY_REDO, UP, XKB_KEY_Ukrainian_i, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_REDO, DOWN, XKB_KEY_A, XKB_KEY_Y, NEXT,
        KEY_REDO, UP, XKB_KEY_Ukrainian_I, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        // Mismatch levels count
        KEY_Q, DOWN, XKB_KEY_Greek_alpha, NEXT,
        KEY_Q, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_Q, DOWN, XKB_KEY_A, NEXT,
        KEY_Q, UP, XKB_KEY_Ukrainian_I, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_RIGHTALT, DOWN, XKB_KEY_ISO_Level3_Shift, NEXT,
        KEY_Q, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_RIGHTALT, UP, XKB_KEY_ISO_Level3_Shift, NEXT,
        KEY_W, DOWN, XKB_KEY_Greek_alpha, NEXT,
        KEY_W, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_W, DOWN, XKB_KEY_A, NEXT,
        KEY_W, UP, XKB_KEY_Ukrainian_I, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_RIGHTALT, DOWN, XKB_KEY_ISO_Level3_Shift, NEXT,
        KEY_W, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_RIGHTALT, UP, XKB_KEY_ISO_Level3_Shift, NEXT,
        // Single keysyms -> single keysyms
        KEY_Y, DOWN, XKB_KEY_Greek_alpha, NEXT,
        KEY_Y, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_Y, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_P, DOWN, XKB_KEY_Greek_alpha, NEXT,
        KEY_P, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_P, DOWN, XKB_KEY_A, NEXT,
        KEY_P, UP, XKB_KEY_Ukrainian_I, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        // Single keysyms -> multiple keysyms
        KEY_A, DOWN, XKB_KEY_Greek_alpha, XKB_KEY_NoSymbol, NEXT,
        KEY_A, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_A, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_S, DOWN, XKB_KEY_Greek_alpha, XKB_KEY_NoSymbol, NEXT,
        KEY_S, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_S, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_D, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_D, DOWN, XKB_KEY_Greek_ALPHA, XKB_KEY_NoSymbol, NEXT,
        KEY_D, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_F, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_F, DOWN, XKB_KEY_Greek_ALPHA, XKB_KEY_NoSymbol, NEXT,
        KEY_F, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_G, DOWN, XKB_KEY_Greek_alpha, XKB_KEY_NoSymbol, NEXT,
        KEY_G, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_G, DOWN, XKB_KEY_Greek_ALPHA, XKB_KEY_NoSymbol, NEXT,
        KEY_G, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_H, DOWN, XKB_KEY_Greek_alpha, XKB_KEY_Greek_upsilon, NEXT,
        KEY_H, UP, XKB_KEY_c_h, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_H, DOWN, XKB_KEY_Greek_ALPHA, XKB_KEY_Greek_UPSILON, NEXT,
        KEY_H, UP, XKB_KEY_C_h, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_J, DOWN, XKB_KEY_Greek_alpha, XKB_KEY_NoSymbol, NEXT,
        KEY_J, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_J, DOWN, XKB_KEY_A, NEXT,
        KEY_J, UP, XKB_KEY_Ukrainian_I, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_K, DOWN, XKB_KEY_Greek_alpha, XKB_KEY_NoSymbol, NEXT,
        KEY_K, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_K, DOWN, XKB_KEY_A, NEXT,
        KEY_K, UP, XKB_KEY_Ukrainian_I, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_L, DOWN, XKB_KEY_a, NEXT,
        KEY_L, UP, XKB_KEY_Ukrainian_i, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_L, DOWN, XKB_KEY_Greek_ALPHA, XKB_KEY_NoSymbol, NEXT,
        KEY_L, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_SEMICOLON, DOWN, XKB_KEY_a, NEXT,
        KEY_SEMICOLON, UP, XKB_KEY_Ukrainian_i, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_SEMICOLON, DOWN, XKB_KEY_Greek_ALPHA, XKB_KEY_NoSymbol, NEXT,
        KEY_SEMICOLON, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_APOSTROPHE, DOWN, XKB_KEY_Greek_alpha, XKB_KEY_NoSymbol, NEXT,
        KEY_APOSTROPHE, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_APOSTROPHE, DOWN, XKB_KEY_Greek_ALPHA, XKB_KEY_NoSymbol, NEXT,
        KEY_APOSTROPHE, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_BACKSLASH, DOWN, XKB_KEY_Greek_alpha, XKB_KEY_Greek_upsilon, NEXT,
        KEY_BACKSLASH, UP, XKB_KEY_c_h, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_BACKSLASH, DOWN, XKB_KEY_Greek_ALPHA, XKB_KEY_Greek_UPSILON, NEXT,
        KEY_BACKSLASH, UP, XKB_KEY_C_h, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        // Multiple keysyms -> multiple keysyms
        KEY_Z, BOTH, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_Z, DOWN, XKB_KEY_Greek_ALPHA, XKB_KEY_Greek_UPSILON, NEXT,
        KEY_Z, UP, XKB_KEY_C_h, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_X, DOWN, XKB_KEY_Greek_alpha, XKB_KEY_NoSymbol, NEXT,
        KEY_X, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_X, DOWN, XKB_KEY_NoSymbol, XKB_KEY_Greek_BETA, NEXT,
        KEY_X, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_C, DOWN, XKB_KEY_Greek_alpha, XKB_KEY_Greek_upsilon, NEXT,
        KEY_C, UP, XKB_KEY_c_h, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_C, DOWN, XKB_KEY_Greek_ALPHA, XKB_KEY_Greek_UPSILON, NEXT,
        KEY_C, UP, XKB_KEY_C_h, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_V, DOWN, XKB_KEY_Greek_alpha, XKB_KEY_NoSymbol, NEXT,
        KEY_V, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_V, DOWN, XKB_KEY_NoSymbol, XKB_KEY_Greek_BETA, NEXT,
        KEY_V, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_B, DOWN, XKB_KEY_Greek_alpha, XKB_KEY_Greek_upsilon, NEXT,
        KEY_B, UP, XKB_KEY_c_h, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_B, DOWN, XKB_KEY_Greek_XI, XKB_KEY_Greek_BETA, NEXT,
        KEY_B, UP, XKB_KEY_C_h, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_N, DOWN, XKB_KEY_a, XKB_KEY_y, NEXT,
        KEY_N, UP, XKB_KEY_Ukrainian_i, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_N, DOWN, XKB_KEY_Greek_ALPHA, XKB_KEY_Greek_UPSILON, NEXT,
        KEY_N, UP, XKB_KEY_C_h, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_M, DOWN, XKB_KEY_Greek_alpha, XKB_KEY_y, NEXT,
        KEY_M, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_M, DOWN, XKB_KEY_X, XKB_KEY_Greek_BETA, NEXT,
        KEY_M, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_COMMA, BOTH, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_COMMA, BOTH, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_DOT, DOWN, XKB_KEY_Greek_alpha, XKB_KEY_NoSymbol, XKB_KEY_Greek_xi, NEXT,
        KEY_DOT, UP, XKB_KEY_c_h, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_DOT, DOWN, XKB_KEY_Greek_XI, XKB_KEY_Greek_BETA, NEXT,
        KEY_DOT, UP, XKB_KEY_C_h, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_SLASH, DOWN, XKB_KEY_a, XKB_KEY_y, NEXT,
        KEY_SLASH, UP, XKB_KEY_Ukrainian_i, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_SLASH, DOWN, XKB_KEY_X, XKB_KEY_NoSymbol, XKB_KEY_A, NEXT,
        KEY_SLASH, UP, XKB_KEY_Ukrainian_I, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_RO, DOWN, XKB_KEY_Greek_alpha, XKB_KEY_NoSymbol, XKB_KEY_Greek_xi, NEXT,
        KEY_RO, UP, XKB_KEY_c_h, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_RO, DOWN, XKB_KEY_Greek_XI, XKB_KEY_Greek_BETA, NEXT,
        KEY_RO, UP, XKB_KEY_C_h, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        // Multiple keysyms -> single keysyms
        KEY_GRAVE, BOTH, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_GRAVE, DOWN, XKB_KEY_A, XKB_KEY_Y, NEXT,
        KEY_GRAVE, UP, XKB_KEY_Ukrainian_I, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_1, DOWN, XKB_KEY_Greek_alpha, NEXT,
        KEY_1, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_1, DOWN, XKB_KEY_Greek_ALPHA, NEXT,
        KEY_1, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_2, DOWN, XKB_KEY_a, XKB_KEY_NoSymbol, NEXT,
        KEY_2, UP, XKB_KEY_Ukrainian_i, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_2, DOWN, XKB_KEY_NoSymbol, XKB_KEY_B, NEXT,
        KEY_2, UP, XKB_KEY_Ukrainian_I, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_3, DOWN, XKB_KEY_Greek_alpha, NEXT,
        KEY_3, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_3, DOWN, XKB_KEY_Greek_ALPHA, NEXT,
        KEY_3, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        // Mix
        KEY_4, DOWN, XKB_KEY_Greek_alpha, XKB_KEY_Greek_upsilon, NEXT,
        KEY_4, UP, XKB_KEY_c_h, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_4, DOWN, XKB_KEY_Greek_ALPHA, XKB_KEY_Greek_UPSILON, NEXT,
        KEY_4, UP, XKB_KEY_C_h, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_5, DOWN, XKB_KEY_Greek_alpha, XKB_KEY_Greek_upsilon, NEXT,
        KEY_5, UP, XKB_KEY_c_h, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_5, DOWN, XKB_KEY_Greek_ALPHA, NEXT,
        KEY_5, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_6, DOWN, XKB_KEY_Greek_alpha, XKB_KEY_Greek_upsilon, NEXT,
        KEY_6, UP, XKB_KEY_c_h, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_6, DOWN, XKB_KEY_Greek_ALPHA, NEXT,
        KEY_6, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, FINISH
    ), "test_merge_modes: keysyms-and-actions, include\n");
    xkb_keymap_unref(keymap);

    /* Mode: Augment */
    const char keymap_keysyms_and_actions_augment[] =
        "xkb_keymap {\n"
        "  xkb_keycodes { include \"evdev\" };\n"
        "  xkb_types { include \"basic+numpad+extra\" };\n"
        "  xkb_compat { include \"basic+iso9995\" };\n"
        "  xkb_symbols {\n"
        "    key <LFSH> { [Shift_L] };\n"
        "    key <RALT> { [ISO_Level3_Shift] };\n"
        "    modifier_map Shift { <LFSH> };\n"
        "    modifier_map Mod5 { <RALT> };\n"
        // NOTE: Separate statements so that *all* the merge modes *really* work.
        //       Using + and | separators downgrades `replace key` to `override/
        //       augment key`.
        "    include \"merge_modes_xkbcommon(keysyms-and-actions_base)\"\n"
        "    augment \"merge_modes_xkbcommon(keysyms-and-actions_new)\"\n"
        "    include \"merge_modes_xkbcommon(group2):2+merge_modes_xkbcommon(group3):3\"\n"
        "  };\n"
        "};";
    fprintf(stderr, "*** test_merge_modes: keysyms-and-actions, augment ***\n");
    keymap = compile_buffer(ctx, keymap_keysyms_and_actions_augment,
                            ARRAY_SIZE(keymap_keysyms_and_actions_augment),
                            private);
    assert(keymap);
    assert_printf(test_key_seq(keymap,
        // Same key
        KEY_REDO, DOWN, XKB_KEY_a, NEXT,
        KEY_REDO, UP, XKB_KEY_Ukrainian_i, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_REDO, DOWN, XKB_KEY_A, XKB_KEY_Y, NEXT,
        KEY_REDO, UP, XKB_KEY_Ukrainian_I, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        // Mismatch levels count
        KEY_Q, DOWN, XKB_KEY_Greek_alpha, NEXT,
        KEY_Q, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_Q, DOWN, XKB_KEY_A, NEXT,
        KEY_Q, UP, XKB_KEY_Ukrainian_I, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_RIGHTALT, DOWN, XKB_KEY_ISO_Level3_Shift, NEXT,
        KEY_Q, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_RIGHTALT, UP, XKB_KEY_ISO_Level3_Shift, NEXT,
        KEY_W, DOWN, XKB_KEY_Greek_alpha, NEXT,
        KEY_W, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_W, DOWN, XKB_KEY_A, NEXT,
        KEY_W, UP, XKB_KEY_Ukrainian_I, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_RIGHTALT, DOWN, XKB_KEY_ISO_Level3_Shift, NEXT,
        KEY_W, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_RIGHTALT, UP, XKB_KEY_ISO_Level3_Shift, NEXT,
        // Single keysyms -> single keysyms
        KEY_Y, DOWN, XKB_KEY_Greek_alpha, NEXT,
        KEY_Y, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_Y, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_P, DOWN, XKB_KEY_a, NEXT,
        KEY_P, UP, XKB_KEY_Ukrainian_i, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_P, DOWN, XKB_KEY_A, NEXT,
        KEY_P, UP, XKB_KEY_Ukrainian_I, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        // Single keysyms -> multiple keysyms
        KEY_A, DOWN, XKB_KEY_Greek_alpha, XKB_KEY_NoSymbol, NEXT,
        KEY_A, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_A, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_S, DOWN, XKB_KEY_Greek_alpha, XKB_KEY_NoSymbol, NEXT,
        KEY_S, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_S, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_D, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_D, DOWN, XKB_KEY_Greek_ALPHA, XKB_KEY_NoSymbol, NEXT,
        KEY_D, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_F, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_F, DOWN, XKB_KEY_Greek_ALPHA, XKB_KEY_NoSymbol, NEXT,
        KEY_F, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_G, DOWN, XKB_KEY_Greek_alpha, XKB_KEY_NoSymbol, NEXT,
        KEY_G, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_G, DOWN, XKB_KEY_Greek_ALPHA, XKB_KEY_NoSymbol, NEXT,
        KEY_G, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_H, DOWN, XKB_KEY_Greek_alpha, XKB_KEY_Greek_upsilon, NEXT,
        KEY_H, UP, XKB_KEY_c_h, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_H, DOWN, XKB_KEY_Greek_ALPHA, XKB_KEY_Greek_UPSILON, NEXT,
        KEY_H, UP, XKB_KEY_C_h, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_J, DOWN, XKB_KEY_a, NEXT,
        KEY_J, UP, XKB_KEY_Ukrainian_i, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_J, DOWN, XKB_KEY_A, NEXT,
        KEY_J, UP, XKB_KEY_Ukrainian_I, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_K, DOWN, XKB_KEY_a, NEXT,
        KEY_K, UP, XKB_KEY_Ukrainian_i, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_K, DOWN, XKB_KEY_A, NEXT,
        KEY_K, UP, XKB_KEY_Ukrainian_I, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_L, DOWN, XKB_KEY_a, NEXT,
        KEY_L, UP, XKB_KEY_Ukrainian_i, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_L, DOWN, XKB_KEY_A, NEXT,
        KEY_L, UP, XKB_KEY_Ukrainian_I, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_SEMICOLON, DOWN, XKB_KEY_a, NEXT,
        KEY_SEMICOLON, UP, XKB_KEY_Ukrainian_i, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_SEMICOLON, DOWN, XKB_KEY_A, NEXT,
        KEY_SEMICOLON, UP, XKB_KEY_Ukrainian_I, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_APOSTROPHE, DOWN, XKB_KEY_a, NEXT,
        KEY_APOSTROPHE, UP, XKB_KEY_Ukrainian_i, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_APOSTROPHE, DOWN, XKB_KEY_A, NEXT,
        KEY_APOSTROPHE, UP, XKB_KEY_Ukrainian_I, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_BACKSLASH, DOWN, XKB_KEY_a, NEXT,
        KEY_BACKSLASH, UP, XKB_KEY_Ukrainian_i, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_BACKSLASH, DOWN, XKB_KEY_A, NEXT,
        KEY_BACKSLASH, UP, XKB_KEY_Ukrainian_I, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        // Multiple keysyms -> multiple keysyms
        KEY_Z, BOTH, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_Z, DOWN, XKB_KEY_Greek_ALPHA, XKB_KEY_Greek_UPSILON, NEXT,
        KEY_Z, UP, XKB_KEY_C_h, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_X, DOWN, XKB_KEY_Greek_alpha, XKB_KEY_NoSymbol, NEXT,
        KEY_X, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_X, DOWN, XKB_KEY_NoSymbol, XKB_KEY_Greek_BETA, NEXT,
        KEY_X, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_C, DOWN, XKB_KEY_Greek_alpha, XKB_KEY_Greek_upsilon, NEXT,
        KEY_C, UP, XKB_KEY_c_h, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_C, DOWN, XKB_KEY_A, XKB_KEY_Y, NEXT,
        KEY_C, UP, XKB_KEY_Ukrainian_I, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_V, DOWN, XKB_KEY_a, XKB_KEY_NoSymbol, NEXT,
        KEY_V, UP, XKB_KEY_Ukrainian_i, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_V, DOWN, XKB_KEY_NoSymbol, XKB_KEY_B, NEXT,
        KEY_V, UP, XKB_KEY_Ukrainian_I, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_B, DOWN, XKB_KEY_a, XKB_KEY_Greek_upsilon, NEXT,
        KEY_B, UP, XKB_KEY_Ukrainian_yi, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_B, DOWN, XKB_KEY_Greek_XI, XKB_KEY_B, NEXT,
        KEY_B, UP, XKB_KEY_Ukrainian_YI, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_N, DOWN, XKB_KEY_a, XKB_KEY_y, NEXT,
        KEY_N, UP, XKB_KEY_Ukrainian_i, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_N, DOWN, XKB_KEY_A, XKB_KEY_Y, NEXT,
        KEY_N, UP, XKB_KEY_Ukrainian_I, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_M, DOWN, XKB_KEY_a, XKB_KEY_y, NEXT,
        KEY_M, UP, XKB_KEY_Ukrainian_i, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_M, DOWN, XKB_KEY_X, XKB_KEY_B, NEXT,
        KEY_M, UP, XKB_KEY_Ukrainian_I, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_COMMA, BOTH, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_COMMA, BOTH, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_DOT, DOWN, XKB_KEY_Greek_alpha, XKB_KEY_NoSymbol, XKB_KEY_Greek_xi, NEXT,
        KEY_DOT, UP, XKB_KEY_c_h, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_DOT, DOWN, XKB_KEY_Greek_XI, XKB_KEY_Greek_BETA, NEXT,
        KEY_DOT, UP, XKB_KEY_C_h, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_SLASH, DOWN, XKB_KEY_a, XKB_KEY_y, NEXT,
        KEY_SLASH, UP, XKB_KEY_Ukrainian_i, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_SLASH, DOWN, XKB_KEY_X, XKB_KEY_NoSymbol, XKB_KEY_A, NEXT,
        KEY_SLASH, UP, XKB_KEY_Ukrainian_I, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_RO, DOWN, XKB_KEY_a, XKB_KEY_y, NEXT,
        KEY_RO, UP, XKB_KEY_Ukrainian_i, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_RO, DOWN, XKB_KEY_X, XKB_KEY_NoSymbol, XKB_KEY_A, NEXT,
        KEY_RO, UP, XKB_KEY_Ukrainian_I, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        // Multiple keysyms -> single keysyms
        KEY_GRAVE, BOTH, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_GRAVE, DOWN, XKB_KEY_A, XKB_KEY_Y, NEXT,
        KEY_GRAVE, UP, XKB_KEY_Ukrainian_I, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_1, DOWN, XKB_KEY_Greek_alpha, NEXT,
        KEY_1, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_1, DOWN, XKB_KEY_A, XKB_KEY_Y, NEXT,
        KEY_1, UP, XKB_KEY_Ukrainian_I, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_2, DOWN, XKB_KEY_a, XKB_KEY_NoSymbol, NEXT,
        KEY_2, UP, XKB_KEY_Ukrainian_i, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_2, DOWN, XKB_KEY_NoSymbol, XKB_KEY_B, NEXT,
        KEY_2, UP, XKB_KEY_Ukrainian_I, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_3, DOWN, XKB_KEY_a, XKB_KEY_NoSymbol, NEXT,
        KEY_3, UP, XKB_KEY_Ukrainian_i, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_3, DOWN, XKB_KEY_NoSymbol, XKB_KEY_B, NEXT,
        KEY_3, UP, XKB_KEY_Ukrainian_I, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        // Mix
        KEY_4, DOWN, XKB_KEY_a, NEXT,
        KEY_4, UP, XKB_KEY_Ukrainian_i, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_4, DOWN, XKB_KEY_Greek_ALPHA, XKB_KEY_Greek_UPSILON, NEXT,
        KEY_4, UP, XKB_KEY_C_h, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_5, DOWN, XKB_KEY_a, XKB_KEY_y, NEXT,
        KEY_5, UP, XKB_KEY_Ukrainian_i, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_5, DOWN, XKB_KEY_Greek_ALPHA, NEXT,
        KEY_5, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_6, DOWN, XKB_KEY_a, NEXT,
        KEY_6, UP, XKB_KEY_Ukrainian_i, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_6, DOWN, XKB_KEY_A, XKB_KEY_Y, NEXT,
        KEY_6, UP, XKB_KEY_Ukrainian_I, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, FINISH
    ), "test_merge_modes: keysyms-and-actions, augment\n");
    xkb_keymap_unref(keymap);

    /* Mode: Override */
    const char keymap_keysyms_and_actions_override[] =
        "xkb_keymap {\n"
        "  xkb_keycodes { include \"evdev\" };\n"
        "  xkb_types { include \"basic+numpad+extra\" };\n"
        "  xkb_compat { include \"basic+iso9995\" };\n"
        "  xkb_symbols {\n"
        "    key <LFSH> { [Shift_L] };\n"
        "    key <RALT> { [ISO_Level3_Shift] };\n"
        "    modifier_map Shift { <LFSH> };\n"
        "    modifier_map Mod5 { <RALT> };\n"
        // NOTE: Separate statements so that *all* the merge modes *really* work.
        //       Using + and | separators downgrades `replace key` to `override/
        //       augment key`.
        "    include \"merge_modes_xkbcommon(keysyms-and-actions_base)\"\n"
        "    override \"merge_modes_xkbcommon(keysyms-and-actions_new)\"\n"
        "    include \"merge_modes_xkbcommon(group2):2+merge_modes_xkbcommon(group3):3\"\n"
        "  };\n"
        "};";
    fprintf(stderr, "*** test_merge_modes: keysyms-and-actions, override ***\n");
    keymap = compile_buffer(ctx, keymap_keysyms_and_actions_override,
                            ARRAY_SIZE(keymap_keysyms_and_actions_override),
                            private);
    assert(keymap);
    assert_printf(test_key_seq(keymap,
        // Same key
        KEY_REDO, DOWN, XKB_KEY_a, NEXT,
        KEY_REDO, UP, XKB_KEY_Ukrainian_i, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_REDO, DOWN, XKB_KEY_A, XKB_KEY_Y, NEXT,
        KEY_REDO, UP, XKB_KEY_Ukrainian_I, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        // Mismatch levels count
        KEY_Q, DOWN, XKB_KEY_Greek_alpha, NEXT,
        KEY_Q, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_Q, DOWN, XKB_KEY_A, NEXT,
        KEY_Q, UP, XKB_KEY_Ukrainian_I, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_RIGHTALT, DOWN, XKB_KEY_ISO_Level3_Shift, NEXT,
        KEY_Q, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_RIGHTALT, UP, XKB_KEY_ISO_Level3_Shift, NEXT,
        KEY_W, DOWN, XKB_KEY_Greek_alpha, NEXT,
        KEY_W, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_W, DOWN, XKB_KEY_A, NEXT,
        KEY_W, UP, XKB_KEY_Ukrainian_I, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_RIGHTALT, DOWN, XKB_KEY_ISO_Level3_Shift, NEXT,
        KEY_W, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_RIGHTALT, UP, XKB_KEY_ISO_Level3_Shift, NEXT,
        // Single keysyms -> single keysyms
        KEY_Y, DOWN, XKB_KEY_Greek_alpha, NEXT,
        KEY_Y, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_Y, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_P, DOWN, XKB_KEY_Greek_alpha, NEXT,
        KEY_P, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_P, DOWN, XKB_KEY_A, NEXT,
        KEY_P, UP, XKB_KEY_Ukrainian_I, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        // Single keysyms -> multiple keysyms
        KEY_A, DOWN, XKB_KEY_Greek_alpha, XKB_KEY_NoSymbol, NEXT,
        KEY_A, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_A, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_S, DOWN, XKB_KEY_Greek_alpha, XKB_KEY_NoSymbol, NEXT,
        KEY_S, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_S, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_D, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_D, DOWN, XKB_KEY_Greek_ALPHA, XKB_KEY_NoSymbol, NEXT,
        KEY_D, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_F, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_F, DOWN, XKB_KEY_Greek_ALPHA, XKB_KEY_NoSymbol, NEXT,
        KEY_F, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_G, DOWN, XKB_KEY_Greek_alpha, XKB_KEY_NoSymbol, NEXT,
        KEY_G, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_G, DOWN, XKB_KEY_Greek_ALPHA, XKB_KEY_NoSymbol, NEXT,
        KEY_G, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_H, DOWN, XKB_KEY_Greek_alpha, XKB_KEY_Greek_upsilon, NEXT,
        KEY_H, UP, XKB_KEY_c_h, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_H, DOWN, XKB_KEY_Greek_ALPHA, XKB_KEY_Greek_UPSILON, NEXT,
        KEY_H, UP, XKB_KEY_C_h, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_J, DOWN, XKB_KEY_Greek_alpha, XKB_KEY_NoSymbol, NEXT,
        KEY_J, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_J, DOWN, XKB_KEY_A, NEXT,
        KEY_J, UP, XKB_KEY_Ukrainian_I, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_K, DOWN, XKB_KEY_Greek_alpha, XKB_KEY_NoSymbol, NEXT,
        KEY_K, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_K, DOWN, XKB_KEY_A, NEXT,
        KEY_K, UP, XKB_KEY_Ukrainian_I, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_L, DOWN, XKB_KEY_a, NEXT,
        KEY_L, UP, XKB_KEY_Ukrainian_i, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_L, DOWN, XKB_KEY_Greek_ALPHA, XKB_KEY_NoSymbol, NEXT,
        KEY_L, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_SEMICOLON, DOWN, XKB_KEY_a, NEXT,
        KEY_SEMICOLON, UP, XKB_KEY_Ukrainian_i, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_SEMICOLON, DOWN, XKB_KEY_Greek_ALPHA, XKB_KEY_NoSymbol, NEXT,
        KEY_SEMICOLON, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_APOSTROPHE, DOWN, XKB_KEY_Greek_alpha, XKB_KEY_NoSymbol, NEXT,
        KEY_APOSTROPHE, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_APOSTROPHE, DOWN, XKB_KEY_Greek_ALPHA, XKB_KEY_NoSymbol, NEXT,
        KEY_APOSTROPHE, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_BACKSLASH, DOWN, XKB_KEY_Greek_alpha, XKB_KEY_Greek_upsilon, NEXT,
        KEY_BACKSLASH, UP, XKB_KEY_c_h, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_BACKSLASH, DOWN, XKB_KEY_Greek_ALPHA, XKB_KEY_Greek_UPSILON, NEXT,
        KEY_BACKSLASH, UP, XKB_KEY_C_h, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        // Multiple keysyms -> multiple keysyms
        KEY_Z, BOTH, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_Z, DOWN, XKB_KEY_Greek_ALPHA, XKB_KEY_Greek_UPSILON, NEXT,
        KEY_Z, UP, XKB_KEY_C_h, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_X, DOWN, XKB_KEY_Greek_alpha, XKB_KEY_NoSymbol, NEXT,
        KEY_X, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_X, DOWN, XKB_KEY_NoSymbol, XKB_KEY_Greek_BETA, NEXT,
        KEY_X, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_C, DOWN, XKB_KEY_Greek_alpha, XKB_KEY_Greek_upsilon, NEXT,
        KEY_C, UP, XKB_KEY_c_h, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_C, DOWN, XKB_KEY_Greek_ALPHA, XKB_KEY_Greek_UPSILON, NEXT,
        KEY_C, UP, XKB_KEY_C_h, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_V, DOWN, XKB_KEY_Greek_alpha, XKB_KEY_NoSymbol, NEXT,
        KEY_V, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_V, DOWN, XKB_KEY_NoSymbol, XKB_KEY_Greek_BETA, NEXT,
        KEY_V, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_B, DOWN, XKB_KEY_Greek_alpha, XKB_KEY_Greek_upsilon, NEXT,
        KEY_B, UP, XKB_KEY_c_h, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_B, DOWN, XKB_KEY_Greek_XI, XKB_KEY_Greek_BETA, NEXT,
        KEY_B, UP, XKB_KEY_C_h, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_N, DOWN, XKB_KEY_a, XKB_KEY_y, NEXT,
        KEY_N, UP, XKB_KEY_Ukrainian_i, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_N, DOWN, XKB_KEY_Greek_ALPHA, XKB_KEY_Greek_UPSILON, NEXT,
        KEY_N, UP, XKB_KEY_C_h, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_M, DOWN, XKB_KEY_Greek_alpha, XKB_KEY_y, NEXT,
        KEY_M, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_M, DOWN, XKB_KEY_X, XKB_KEY_Greek_BETA, NEXT,
        KEY_M, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_COMMA, BOTH, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_COMMA, BOTH, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_DOT, DOWN, XKB_KEY_Greek_alpha, XKB_KEY_NoSymbol, XKB_KEY_Greek_xi, NEXT,
        KEY_DOT, UP, XKB_KEY_c_h, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_DOT, DOWN, XKB_KEY_Greek_XI, XKB_KEY_Greek_BETA, NEXT,
        KEY_DOT, UP, XKB_KEY_C_h, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_SLASH, DOWN, XKB_KEY_a, XKB_KEY_y, NEXT,
        KEY_SLASH, UP, XKB_KEY_Ukrainian_i, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_SLASH, DOWN, XKB_KEY_X, XKB_KEY_NoSymbol, XKB_KEY_A, NEXT,
        KEY_SLASH, UP, XKB_KEY_Ukrainian_I, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_RO, DOWN, XKB_KEY_Greek_alpha, XKB_KEY_NoSymbol, XKB_KEY_Greek_xi, NEXT,
        KEY_RO, UP, XKB_KEY_c_h, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_RO, DOWN, XKB_KEY_Greek_XI, XKB_KEY_Greek_BETA, NEXT,
        KEY_RO, UP, XKB_KEY_C_h, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        // Multiple keysyms -> single keysyms
        KEY_GRAVE, BOTH, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_GRAVE, DOWN, XKB_KEY_A, XKB_KEY_Y, NEXT,
        KEY_GRAVE, UP, XKB_KEY_Ukrainian_I, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_1, DOWN, XKB_KEY_Greek_alpha, NEXT,
        KEY_1, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_1, DOWN, XKB_KEY_Greek_ALPHA, NEXT,
        KEY_1, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_2, DOWN, XKB_KEY_a, XKB_KEY_NoSymbol, NEXT,
        KEY_2, UP, XKB_KEY_Ukrainian_i, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_2, DOWN, XKB_KEY_NoSymbol, XKB_KEY_B, NEXT,
        KEY_2, UP, XKB_KEY_Ukrainian_I, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_3, DOWN, XKB_KEY_Greek_alpha, NEXT,
        KEY_3, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_3, DOWN, XKB_KEY_Greek_ALPHA, NEXT,
        KEY_3, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        // Mix
        KEY_4, DOWN, XKB_KEY_Greek_alpha, XKB_KEY_Greek_upsilon, NEXT,
        KEY_4, UP, XKB_KEY_c_h, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_4, DOWN, XKB_KEY_Greek_ALPHA, XKB_KEY_Greek_UPSILON, NEXT,
        KEY_4, UP, XKB_KEY_C_h, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_5, DOWN, XKB_KEY_Greek_alpha, XKB_KEY_Greek_upsilon, NEXT,
        KEY_5, UP, XKB_KEY_c_h, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_5, DOWN, XKB_KEY_Greek_ALPHA, NEXT,
        KEY_5, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_6, DOWN, XKB_KEY_Greek_alpha, XKB_KEY_Greek_upsilon, NEXT,
        KEY_6, UP, XKB_KEY_c_h, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_6, DOWN, XKB_KEY_Greek_ALPHA, NEXT,
        KEY_6, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, FINISH
    ), "test_merge_modes: keysyms-and-actions, override\n");
    xkb_keymap_unref(keymap);

    /* Mode: Replace */
    const char keymap_keysyms_and_actions_replace[] =
        "xkb_keymap {\n"
        "  xkb_keycodes { include \"evdev\" };\n"
        "  xkb_types { include \"basic+numpad+extra\" };\n"
        "  xkb_compat { include \"basic+iso9995\" };\n"
        "  xkb_symbols {\n"
        "    key <LFSH> { [Shift_L] };\n"
        "    key <RALT> { [ISO_Level3_Shift] };\n"
        "    modifier_map Shift { <LFSH> };\n"
        "    modifier_map Mod5 { <RALT> };\n"
        // NOTE: Separate statements so that *all* the merge modes *really* work.
        //       Using + and | separators downgrades `replace key` to `override/
        //       augment key`.
        "    include \"merge_modes_xkbcommon(keysyms-and-actions_base)\"\n"
        "    replace \"merge_modes_xkbcommon(keysyms-and-actions_new)\"\n"
        "    include \"merge_modes_xkbcommon(group2):2+merge_modes_xkbcommon(group3):3\"\n"
        "  };\n"
        "};";
    fprintf(stderr, "*** test_merge_modes: keysyms-and-actions, replace ***\n");
    keymap = compile_buffer(ctx, keymap_keysyms_and_actions_replace,
                            ARRAY_SIZE(keymap_keysyms_and_actions_replace),
                            private);
    assert(keymap);
    assert_printf(test_key_seq(keymap,
        // Same key
        KEY_REDO, DOWN, XKB_KEY_a, NEXT,
        KEY_REDO, UP, XKB_KEY_Ukrainian_i, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_REDO, DOWN, XKB_KEY_A, XKB_KEY_Y, NEXT,
        KEY_REDO, UP, XKB_KEY_Ukrainian_I, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        // Mismatch levels count
        KEY_Q, DOWN, XKB_KEY_Greek_alpha, NEXT,
        KEY_Q, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_Q, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_RIGHTALT, DOWN, XKB_KEY_ISO_Level3_Shift, NEXT,
        KEY_Q, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_RIGHTALT, UP, XKB_KEY_ISO_Level3_Shift, NEXT,
        KEY_W, DOWN, XKB_KEY_Greek_alpha, NEXT,
        KEY_W, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_W, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        // Single keysyms -> single keysyms
        KEY_Y, DOWN, XKB_KEY_Greek_alpha, NEXT,
        KEY_Y, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_Y, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_P, DOWN, XKB_KEY_Greek_alpha, NEXT,
        KEY_P, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_P, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        // Single keysyms -> multiple keysyms
        KEY_A, DOWN, XKB_KEY_Greek_alpha, XKB_KEY_NoSymbol, NEXT,
        KEY_A, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_A, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_S, DOWN, XKB_KEY_Greek_alpha, XKB_KEY_NoSymbol, NEXT,
        KEY_S, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_S, BOTH, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_D, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_D, DOWN, XKB_KEY_Greek_ALPHA, XKB_KEY_NoSymbol, NEXT,
        KEY_D, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_F, BOTH, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_F, DOWN, XKB_KEY_Greek_ALPHA, XKB_KEY_NoSymbol, NEXT,
        KEY_F, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_G, DOWN, XKB_KEY_Greek_alpha, XKB_KEY_NoSymbol, NEXT,
        KEY_G, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_G, DOWN, XKB_KEY_Greek_ALPHA, XKB_KEY_NoSymbol, NEXT,
        KEY_G, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_H, DOWN, XKB_KEY_Greek_alpha, XKB_KEY_Greek_upsilon, NEXT,
        KEY_H, UP, XKB_KEY_c_h, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_H, DOWN, XKB_KEY_Greek_ALPHA, XKB_KEY_Greek_UPSILON, NEXT,
        KEY_H, UP, XKB_KEY_C_h, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_J, DOWN, XKB_KEY_Greek_alpha, XKB_KEY_NoSymbol, NEXT,
        KEY_J, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_J, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_K, DOWN, XKB_KEY_Greek_alpha, XKB_KEY_NoSymbol, NEXT,
        KEY_K, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_K, BOTH, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_L, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_L, DOWN, XKB_KEY_Greek_ALPHA, XKB_KEY_NoSymbol, NEXT,
        KEY_L, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_SEMICOLON, BOTH, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_SEMICOLON, DOWN, XKB_KEY_Greek_ALPHA, XKB_KEY_NoSymbol, NEXT,
        KEY_SEMICOLON, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_APOSTROPHE, DOWN, XKB_KEY_Greek_alpha, XKB_KEY_NoSymbol, NEXT,
        KEY_APOSTROPHE, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_APOSTROPHE, DOWN, XKB_KEY_Greek_ALPHA, XKB_KEY_NoSymbol, NEXT,
        KEY_APOSTROPHE, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_BACKSLASH, DOWN, XKB_KEY_Greek_alpha, XKB_KEY_Greek_upsilon, NEXT,
        KEY_BACKSLASH, UP, XKB_KEY_c_h, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_BACKSLASH, DOWN, XKB_KEY_Greek_ALPHA, XKB_KEY_Greek_UPSILON, NEXT,
        KEY_BACKSLASH, UP, XKB_KEY_C_h, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        // Multiple keysyms -> multiple keysyms
        KEY_Z, BOTH, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_Z, DOWN, XKB_KEY_Greek_ALPHA, XKB_KEY_Greek_UPSILON, NEXT,
        KEY_Z, UP, XKB_KEY_C_h, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_X, DOWN, XKB_KEY_Greek_alpha, XKB_KEY_NoSymbol, NEXT,
        KEY_X, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_X, DOWN, XKB_KEY_NoSymbol, XKB_KEY_Greek_BETA, NEXT,
        KEY_X, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_C, DOWN, XKB_KEY_Greek_alpha, XKB_KEY_Greek_upsilon, NEXT,
        KEY_C, UP, XKB_KEY_c_h, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_C, DOWN, XKB_KEY_Greek_ALPHA, XKB_KEY_Greek_UPSILON, NEXT,
        KEY_C, UP, XKB_KEY_C_h, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_V, DOWN, XKB_KEY_Greek_alpha, XKB_KEY_NoSymbol, NEXT,
        KEY_V, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_V, DOWN, XKB_KEY_NoSymbol, XKB_KEY_Greek_BETA, NEXT,
        KEY_V, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_B, DOWN, XKB_KEY_Greek_alpha, XKB_KEY_Greek_upsilon, NEXT,
        KEY_B, UP, XKB_KEY_c_h, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_B, DOWN, XKB_KEY_Greek_XI, XKB_KEY_Greek_BETA, NEXT,
        KEY_B, UP, XKB_KEY_C_h, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_N, BOTH, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_N, DOWN, XKB_KEY_Greek_ALPHA, XKB_KEY_Greek_UPSILON, NEXT,
        KEY_N, UP, XKB_KEY_C_h, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_M, DOWN, XKB_KEY_Greek_alpha, XKB_KEY_NoSymbol, NEXT,
        KEY_M, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_M, DOWN, XKB_KEY_NoSymbol, XKB_KEY_Greek_BETA, NEXT,
        KEY_M, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_COMMA, BOTH, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_COMMA, BOTH, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_DOT, DOWN, XKB_KEY_Greek_alpha, XKB_KEY_NoSymbol, XKB_KEY_Greek_xi, NEXT,
        KEY_DOT, UP, XKB_KEY_c_h, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_DOT, DOWN, XKB_KEY_Greek_XI, XKB_KEY_Greek_BETA, NEXT,
        KEY_DOT, UP, XKB_KEY_C_h, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_SLASH, BOTH, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_SLASH, BOTH, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_RO, DOWN, XKB_KEY_Greek_alpha, XKB_KEY_NoSymbol, XKB_KEY_Greek_xi, NEXT,
        KEY_RO, UP, XKB_KEY_c_h, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_RO, DOWN, XKB_KEY_Greek_XI, XKB_KEY_Greek_BETA, NEXT,
        KEY_RO, UP, XKB_KEY_C_h, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        // Multiple keysyms -> single keysyms
        KEY_GRAVE, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_GRAVE, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_1, DOWN, XKB_KEY_Greek_alpha, NEXT,
        KEY_1, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_1, DOWN, XKB_KEY_Greek_ALPHA, NEXT,
        KEY_1, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_2, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_2, BOTH, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_3, DOWN, XKB_KEY_Greek_alpha, NEXT,
        KEY_3, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_3, DOWN, XKB_KEY_Greek_ALPHA, NEXT,
        KEY_3, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        // Mix
        KEY_4, DOWN, XKB_KEY_Greek_alpha, XKB_KEY_Greek_upsilon, NEXT,
        KEY_4, UP, XKB_KEY_c_h, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_4, DOWN, XKB_KEY_Greek_ALPHA, XKB_KEY_Greek_UPSILON, NEXT,
        KEY_4, UP, XKB_KEY_C_h, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_5, DOWN, XKB_KEY_Greek_alpha, XKB_KEY_Greek_upsilon, NEXT,
        KEY_5, UP, XKB_KEY_c_h, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_5, DOWN, XKB_KEY_Greek_ALPHA, NEXT,
        KEY_5, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_6, DOWN, XKB_KEY_Greek_alpha, XKB_KEY_Greek_upsilon, NEXT,
        KEY_6, UP, XKB_KEY_c_h, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_6, DOWN, XKB_KEY_Greek_ALPHA, NEXT,
        KEY_6, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, FINISH
    ), "test_merge_modes: keysyms-and-actions, replace\n");
    xkb_keymap_unref(keymap);

    /****************************************************************
     * Test group: keysyms-and-actions-extras
     ****************************************************************/

    /* Mode: Default */
    const char keymap_keysyms_and_actions_extras_include[] =
        "xkb_keymap {\n"
        "  xkb_keycodes { include \"evdev\" };\n"
        "  xkb_types { include \"basic+numpad+extra\" };\n"
        "  xkb_compat { include \"basic+iso9995\" };\n"
        "  xkb_symbols {\n"
        "    key <LFSH> { [Shift_L] };\n"
        "    key <RALT> { [ISO_Level3_Shift] };\n"
        "    modifier_map Shift { <LFSH> };\n"
        "    modifier_map Mod5 { <RALT> };\n"
        // NOTE: Separate statements so that *all* the merge modes *really* work.
        //       Using + and | separators downgrades `replace key` to `override/
        //       augment key`.
        "    include \"merge_modes_xkbcommon(keysyms-and-actions-extras_base)\"\n"
        "    include \"merge_modes_xkbcommon(keysyms-and-actions-extras_new)\"\n"
        "    include \"merge_modes_xkbcommon(group2):2+merge_modes_xkbcommon(group3):3\"\n"
        "  };\n"
        "};";
    fprintf(stderr, "*** test_merge_modes: keysyms-and-actions-extras, include ***\n");
    keymap = compile_buffer(ctx, keymap_keysyms_and_actions_extras_include,
                            ARRAY_SIZE(keymap_keysyms_and_actions_extras_include),
                            private);
    assert(keymap);
    assert_printf(test_key_seq(keymap,
        KEY_1, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_1, UP, XKB_KEY_c_h, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_1, BOTH, XKB_KEY_X, XKB_KEY_Y, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        // Multiple keysyms/actions > single
        KEY_2, DOWN, XKB_KEY_NoSymbol, NEXT,
        KEY_2, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_2, BOTH, XKB_KEY_X, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        // Multiple keysyms/actions > multiple (xor)
        KEY_3, DOWN, XKB_KEY_a, XKB_KEY_b, NEXT,
        KEY_3, UP, XKB_KEY_c_h, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_3, DOWN, XKB_KEY_X, XKB_KEY_Y, NEXT,
        KEY_3, UP, XKB_KEY_Ukrainian_I, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        // Multiple keysyms/actions > multiple (mix)
        KEY_4, DOWN, XKB_KEY_x, XKB_KEY_y, NEXT,
        KEY_4, UP, XKB_KEY_c_h, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_4, DOWN, XKB_KEY_X, XKB_KEY_Y, NEXT,
        KEY_4, UP, XKB_KEY_C_h, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_5, DOWN, XKB_KEY_x, XKB_KEY_b, NEXT,
        KEY_5, UP, XKB_KEY_c_h, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_5, DOWN, XKB_KEY_X, XKB_KEY_Y, NEXT,
        KEY_5, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        // Multiple (mix) > multiple keysyms/actions
        KEY_6, DOWN, XKB_KEY_x, XKB_KEY_b, NEXT,
        KEY_6, UP, XKB_KEY_Ukrainian_i, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_6, DOWN, XKB_KEY_A, XKB_KEY_B, NEXT,
        KEY_6, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_7, DOWN, XKB_KEY_x, XKB_KEY_y, NEXT,
        KEY_7, UP, XKB_KEY_Ukrainian_i, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_7, DOWN, XKB_KEY_A, XKB_KEY_B, NEXT,
        KEY_7, UP, XKB_KEY_C_h, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        // Multiple (mix) > multiple (mix)
        KEY_8, DOWN, XKB_KEY_a, XKB_KEY_y, NEXT,
        KEY_8, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_8, DOWN, XKB_KEY_X, XKB_KEY_Y, NEXT,
        KEY_8, UP, XKB_KEY_C_h, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_9, DOWN, XKB_KEY_a, XKB_KEY_y, NEXT,
        KEY_9, UP, XKB_KEY_Ukrainian_yi, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_9, DOWN, XKB_KEY_X, XKB_KEY_B, NEXT,
        KEY_9, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        // Mismatch count with mix
        KEY_Q, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_Q, UP, XKB_KEY_c_h, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_Q, DOWN, XKB_KEY_NoSymbol, NEXT,
        KEY_Q, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_W, BOTH, XKB_KEY_A, XKB_KEY_B, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_W, BOTH, XKB_KEY_a, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_E, DOWN, XKB_KEY_x, XKB_KEY_y, NEXT,
        KEY_E, UP, XKB_KEY_c_h, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_E, DOWN, XKB_KEY_X, NEXT,
        KEY_E, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        // Issue #564
        KEY_A, DOWN, XKB_KEY_A, XKB_KEY_A, NEXT,
        KEY_A, UP, XKB_KEY_c_h, FINISH
    ), "test_merge_modes: keysyms-and-actions-extras, include\n");
    xkb_keymap_unref(keymap);

    /* Mode: Augment */
    const char keymap_keysyms_and_actions_extras_augment[] =
        "xkb_keymap {\n"
        "  xkb_keycodes { include \"evdev\" };\n"
        "  xkb_types { include \"basic+numpad+extra\" };\n"
        "  xkb_compat { include \"basic+iso9995\" };\n"
        "  xkb_symbols {\n"
        "    key <LFSH> { [Shift_L] };\n"
        "    key <RALT> { [ISO_Level3_Shift] };\n"
        "    modifier_map Shift { <LFSH> };\n"
        "    modifier_map Mod5 { <RALT> };\n"
        // NOTE: Separate statements so that *all* the merge modes *really* work.
        //       Using + and | separators downgrades `replace key` to `override/
        //       augment key`.
        "    include \"merge_modes_xkbcommon(keysyms-and-actions-extras_base)\"\n"
        "    augment \"merge_modes_xkbcommon(keysyms-and-actions-extras_new)\"\n"
        "    include \"merge_modes_xkbcommon(group2):2+merge_modes_xkbcommon(group3):3\"\n"
        "  };\n"
        "};";
    fprintf(stderr, "*** test_merge_modes: keysyms-and-actions-extras, augment ***\n");
    keymap = compile_buffer(ctx, keymap_keysyms_and_actions_extras_augment,
                            ARRAY_SIZE(keymap_keysyms_and_actions_extras_augment),
                            private);
    assert(keymap);
    assert_printf(test_key_seq(keymap,
        KEY_1, BOTH, XKB_KEY_a, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_1, DOWN, XKB_KEY_NoSymbol, NEXT,
        KEY_1, UP, XKB_KEY_Ukrainian_I, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        // Multiple keysyms/actions > single
        KEY_2, BOTH, XKB_KEY_a, XKB_KEY_b, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_2, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_2, UP, XKB_KEY_Ukrainian_I, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        // Multiple keysyms/actions > multiple (xor)
        KEY_3, DOWN, XKB_KEY_a, XKB_KEY_b, NEXT,
        KEY_3, UP, XKB_KEY_c_h, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_3, DOWN, XKB_KEY_X, XKB_KEY_Y, NEXT,
        KEY_3, UP, XKB_KEY_Ukrainian_I, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        // Multiple keysyms/actions > multiple (mix)
        KEY_4, DOWN, XKB_KEY_a, XKB_KEY_y, NEXT,
        KEY_4, UP, XKB_KEY_c_h, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_4, DOWN, XKB_KEY_X, XKB_KEY_Y, NEXT,
        KEY_4, UP, XKB_KEY_Ukrainian_YI, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_5, DOWN, XKB_KEY_a, XKB_KEY_b, NEXT,
        KEY_5, UP, XKB_KEY_c_h, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_5, DOWN, XKB_KEY_X, XKB_KEY_Y, NEXT,
        KEY_5, UP, XKB_KEY_Ukrainian_I, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        // Multiple (mix) > multiple keysyms/actions
        KEY_6, DOWN, XKB_KEY_a, XKB_KEY_b, NEXT,
        KEY_6, UP, XKB_KEY_Ukrainian_i, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_6, DOWN, XKB_KEY_A, XKB_KEY_B, NEXT,
        KEY_6, UP, XKB_KEY_Ukrainian_I, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_7, DOWN, XKB_KEY_a, XKB_KEY_y, NEXT,
        KEY_7, UP, XKB_KEY_Ukrainian_i, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_7, DOWN, XKB_KEY_A, XKB_KEY_B, NEXT,
        KEY_7, UP, XKB_KEY_Ukrainian_YI, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        // Multiple (mix) > multiple (mix)
        KEY_8, DOWN, XKB_KEY_a, XKB_KEY_b, NEXT,
        KEY_8, UP, XKB_KEY_Ukrainian_i, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_8, DOWN, XKB_KEY_X, XKB_KEY_B, NEXT,
        KEY_8, UP, XKB_KEY_Ukrainian_YI, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_9, DOWN, XKB_KEY_a, XKB_KEY_y, NEXT,
        KEY_9, UP, XKB_KEY_Ukrainian_yi, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_9, DOWN, XKB_KEY_X, XKB_KEY_B, NEXT,
        KEY_9, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        // Mismatch count with mix
        KEY_Q, BOTH, XKB_KEY_a, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_Q, BOTH, XKB_KEY_A, XKB_KEY_B, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_W, DOWN, XKB_KEY_NoSymbol, NEXT,
        KEY_W, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_W, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_W, UP, XKB_KEY_C_h, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_E, DOWN, XKB_KEY_a, NEXT,
        KEY_E, UP, XKB_KEY_Ukrainian_i, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_E, DOWN, XKB_KEY_A, XKB_KEY_B, NEXT,
        KEY_E, UP, XKB_KEY_Ukrainian_I, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        // Issue #564
        KEY_A, BOTH, XKB_KEY_A, FINISH
    ), "test_merge_modes: keysyms-and-actions-extras, augment\n");
    xkb_keymap_unref(keymap);

    /* Mode: Override */
    const char keymap_keysyms_and_actions_extras_override[] =
        "xkb_keymap {\n"
        "  xkb_keycodes { include \"evdev\" };\n"
        "  xkb_types { include \"basic+numpad+extra\" };\n"
        "  xkb_compat { include \"basic+iso9995\" };\n"
        "  xkb_symbols {\n"
        "    key <LFSH> { [Shift_L] };\n"
        "    key <RALT> { [ISO_Level3_Shift] };\n"
        "    modifier_map Shift { <LFSH> };\n"
        "    modifier_map Mod5 { <RALT> };\n"
        // NOTE: Separate statements so that *all* the merge modes *really* work.
        //       Using + and | separators downgrades `replace key` to `override/
        //       augment key`.
        "    include \"merge_modes_xkbcommon(keysyms-and-actions-extras_base)\"\n"
        "    override \"merge_modes_xkbcommon(keysyms-and-actions-extras_new)\"\n"
        "    include \"merge_modes_xkbcommon(group2):2+merge_modes_xkbcommon(group3):3\"\n"
        "  };\n"
        "};";
    fprintf(stderr, "*** test_merge_modes: keysyms-and-actions-extras, override ***\n");
    keymap = compile_buffer(ctx, keymap_keysyms_and_actions_extras_override,
                            ARRAY_SIZE(keymap_keysyms_and_actions_extras_override),
                            private);
    assert(keymap);
    assert_printf(test_key_seq(keymap,
        KEY_1, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_1, UP, XKB_KEY_c_h, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_1, BOTH, XKB_KEY_X, XKB_KEY_Y, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        // Multiple keysyms/actions > single
        KEY_2, DOWN, XKB_KEY_NoSymbol, NEXT,
        KEY_2, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_2, BOTH, XKB_KEY_X, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        // Multiple keysyms/actions > multiple (xor)
        KEY_3, DOWN, XKB_KEY_a, XKB_KEY_b, NEXT,
        KEY_3, UP, XKB_KEY_c_h, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_3, DOWN, XKB_KEY_X, XKB_KEY_Y, NEXT,
        KEY_3, UP, XKB_KEY_Ukrainian_I, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        // Multiple keysyms/actions > multiple (mix)
        KEY_4, DOWN, XKB_KEY_x, XKB_KEY_y, NEXT,
        KEY_4, UP, XKB_KEY_c_h, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_4, DOWN, XKB_KEY_X, XKB_KEY_Y, NEXT,
        KEY_4, UP, XKB_KEY_C_h, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_5, DOWN, XKB_KEY_x, XKB_KEY_b, NEXT,
        KEY_5, UP, XKB_KEY_c_h, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_5, DOWN, XKB_KEY_X, XKB_KEY_Y, NEXT,
        KEY_5, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        // Multiple (mix) > multiple keysyms/actions
        KEY_6, DOWN, XKB_KEY_x, XKB_KEY_b, NEXT,
        KEY_6, UP, XKB_KEY_Ukrainian_i, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_6, DOWN, XKB_KEY_A, XKB_KEY_B, NEXT,
        KEY_6, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_7, DOWN, XKB_KEY_x, XKB_KEY_y, NEXT,
        KEY_7, UP, XKB_KEY_Ukrainian_i, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_7, DOWN, XKB_KEY_A, XKB_KEY_B, NEXT,
        KEY_7, UP, XKB_KEY_C_h, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        // Multiple (mix) > multiple (mix)
        KEY_8, DOWN, XKB_KEY_a, XKB_KEY_y, NEXT,
        KEY_8, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_8, DOWN, XKB_KEY_X, XKB_KEY_Y, NEXT,
        KEY_8, UP, XKB_KEY_C_h, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_9, DOWN, XKB_KEY_a, XKB_KEY_y, NEXT,
        KEY_9, UP, XKB_KEY_Ukrainian_yi, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_9, DOWN, XKB_KEY_X, XKB_KEY_B, NEXT,
        KEY_9, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        // Mismatch count with mix
        KEY_Q, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_Q, UP, XKB_KEY_c_h, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_Q, DOWN, XKB_KEY_NoSymbol, NEXT,
        KEY_Q, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_W, BOTH, XKB_KEY_A, XKB_KEY_B, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_W, BOTH, XKB_KEY_a, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_E, DOWN, XKB_KEY_x, XKB_KEY_y, NEXT,
        KEY_E, UP, XKB_KEY_c_h, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_E, DOWN, XKB_KEY_X, NEXT,
        KEY_E, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        // Issue #564
        KEY_A, DOWN, XKB_KEY_A, XKB_KEY_A, NEXT,
        KEY_A, UP, XKB_KEY_c_h, FINISH
    ), "test_merge_modes: keysyms-and-actions-extras, override\n");
    xkb_keymap_unref(keymap);

    /* Mode: Replace */
    const char keymap_keysyms_and_actions_extras_replace[] =
        "xkb_keymap {\n"
        "  xkb_keycodes { include \"evdev\" };\n"
        "  xkb_types { include \"basic+numpad+extra\" };\n"
        "  xkb_compat { include \"basic+iso9995\" };\n"
        "  xkb_symbols {\n"
        "    key <LFSH> { [Shift_L] };\n"
        "    key <RALT> { [ISO_Level3_Shift] };\n"
        "    modifier_map Shift { <LFSH> };\n"
        "    modifier_map Mod5 { <RALT> };\n"
        // NOTE: Separate statements so that *all* the merge modes *really* work.
        //       Using + and | separators downgrades `replace key` to `override/
        //       augment key`.
        "    include \"merge_modes_xkbcommon(keysyms-and-actions-extras_base)\"\n"
        "    replace \"merge_modes_xkbcommon(keysyms-and-actions-extras_new)\"\n"
        "    include \"merge_modes_xkbcommon(group2):2+merge_modes_xkbcommon(group3):3\"\n"
        "  };\n"
        "};";
    fprintf(stderr, "*** test_merge_modes: keysyms-and-actions-extras, replace ***\n");
    keymap = compile_buffer(ctx, keymap_keysyms_and_actions_extras_replace,
                            ARRAY_SIZE(keymap_keysyms_and_actions_extras_replace),
                            private);
    assert(keymap);
    assert_printf(test_key_seq(keymap,
        KEY_1, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_1, UP, XKB_KEY_c_h, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_1, BOTH, XKB_KEY_X, XKB_KEY_Y, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        // Multiple keysyms/actions > single
        KEY_2, DOWN, XKB_KEY_NoSymbol, NEXT,
        KEY_2, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_2, BOTH, XKB_KEY_X, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        // Multiple keysyms/actions > multiple (xor)
        KEY_3, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_3, UP, XKB_KEY_c_h, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_3, BOTH, XKB_KEY_X, XKB_KEY_Y, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        // Multiple keysyms/actions > multiple (mix)
        KEY_4, DOWN, XKB_KEY_x, XKB_KEY_y, NEXT,
        KEY_4, UP, XKB_KEY_c_h, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_4, DOWN, XKB_KEY_X, XKB_KEY_Y, NEXT,
        KEY_4, UP, XKB_KEY_C_h, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_5, DOWN, XKB_KEY_x, XKB_KEY_NoSymbol, NEXT,
        KEY_5, UP, XKB_KEY_c_h, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_5, DOWN, XKB_KEY_X, XKB_KEY_Y, NEXT,
        KEY_5, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        // Multiple (mix) > multiple keysyms/actions
        KEY_6, BOTH, XKB_KEY_x, XKB_KEY_NoSymbol, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_6, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_6, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_7, BOTH, XKB_KEY_x, XKB_KEY_y, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_7, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_7, UP, XKB_KEY_C_h, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        // Multiple (mix) > multiple (mix)
        KEY_8, DOWN, XKB_KEY_NoSymbol, XKB_KEY_y, NEXT,
        KEY_8, UP, XKB_KEY_ch, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_8, DOWN, XKB_KEY_X, XKB_KEY_Y, NEXT,
        KEY_8, UP, XKB_KEY_C_h, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_9, BOTH, XKB_KEY_NoSymbol, XKB_KEY_y, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_9, DOWN, XKB_KEY_X, XKB_KEY_NoSymbol, NEXT,
        KEY_9, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        // Mismatch count with mix
        KEY_Q, DOWN, XKB_KEY_NoSymbol, XKB_KEY_NoSymbol, NEXT,
        KEY_Q, UP, XKB_KEY_c_h, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_Q, DOWN, XKB_KEY_NoSymbol, NEXT,
        KEY_Q, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_W, BOTH, XKB_KEY_A, XKB_KEY_B, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_W, BOTH, XKB_KEY_a, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        KEY_E, DOWN, XKB_KEY_x, XKB_KEY_y, NEXT,
        KEY_E, UP, XKB_KEY_c_h, NEXT,
        KEY_LEFTSHIFT, DOWN, XKB_KEY_Shift_L, NEXT,
        KEY_E, DOWN, XKB_KEY_X, NEXT,
        KEY_E, UP, XKB_KEY_Ch, NEXT,
        KEY_LEFTSHIFT, UP, XKB_KEY_Shift_L, NEXT,
        // Issue #564
        KEY_A, DOWN, XKB_KEY_A, XKB_KEY_A, NEXT,
        KEY_A, UP, XKB_KEY_c_h, FINISH
    ), "test_merge_modes: keysyms-and-actions-extras, replace\n");
    xkb_keymap_unref(keymap);
}
